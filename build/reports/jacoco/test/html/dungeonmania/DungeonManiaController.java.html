<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DungeonManiaController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">dungeonmania</a> &gt; <span class="el_source">DungeonManiaController.java</span></div><h1>DungeonManiaController.java</h1><pre class="source lang-java linenums">package dungeonmania;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.sql.Time;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ThreadLocalRandom;

import org.eclipse.jetty.util.DateCache.Tick;
import org.json.JSONArray;
import org.json.JSONObject;
import org.json.JSONTokener;

import dungeonmania.exceptions.InvalidActionException;
import dungeonmania.response.models.DungeonResponse;
import dungeonmania.response.models.EntityResponse;
import dungeonmania.response.models.ItemResponse;
import dungeonmania.util.Direction;
import dungeonmania.util.FileLoader;
import dungeonmania.util.Position;
import dungeonmania.util.Prims;
import dungeonmania.Battles.BattleOutcome;

public class DungeonManiaController {
    private ArrayList&lt;DungeonMania&gt; games;
    private DungeonMania loadedgame;
    private int tick;
    private int TimeTravelDuration;
    private Map&lt;Integer, Direction&gt; oldDirection;
    private Map &lt;Integer, String&gt; oldItem;
<span class="fc" id="L37">    public DungeonManiaController() {</span>
<span class="fc" id="L38">        this.games = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L39">        this.tick = 0;</span>
<span class="fc" id="L40">        this.oldDirection = new HashMap&lt;&gt;();</span>
<span class="fc" id="L41">        this.oldItem = new HashMap&lt;&gt;();</span>
<span class="fc" id="L42">        this.TimeTravelDuration = 0;</span>
<span class="fc" id="L43">    }</span>

    /**
     * Gets list of existing games
     * 
     * @return ArrayList&lt;DungeonMania&gt;
     */
    public ArrayList&lt;DungeonMania&gt; getGames() {
<span class="fc" id="L51">        return games;</span>
    }

    /**
     * Sets the list of existing games
     * 
     * @param games
     */
    public void setGames(ArrayList&lt;DungeonMania&gt; games) {
<span class="nc" id="L60">        this.games = games;</span>
<span class="nc" id="L61">    }</span>

    /**
     * Gets current skin
     * 
     * @return String
     */
    public String getSkin() {
<span class="nc" id="L69">        return &quot;default&quot;;</span>
    }

    /**
     * Gets localisation
     * 
     * @return String
     */
    public String getLocalisation() {
<span class="nc" id="L78">        return &quot;en_US&quot;;</span>
    }

    /**
     * Gets list of gamemodes
     * 
     * @return List&lt;String&gt;
     */
    public List&lt;String&gt; getGameModes() {
<span class="nc" id="L87">        return Arrays.asList(&quot;Standard&quot;, &quot;Peaceful&quot;, &quot;Hard&quot;);</span>
    }

    /**
     * /dungeons
     * 
     * Done for you.
     */
    public static List&lt;String&gt; dungeons() {
        try {
<span class="fc" id="L97">            return FileLoader.listFileNamesInResourceDirectory(&quot;/dungeons&quot;);</span>
<span class="nc" id="L98">        } catch (IOException e) {</span>
<span class="nc" id="L99">            return new ArrayList&lt;&gt;();</span>
        }
    }

    /**
     * Initializes game state + spawns in all entities and main character + items
     * 
     * @param dungeonName
     * @param gameMode
     * @return DungeonResponse
     * @throws IllegalArgumentException
     */
    public DungeonResponse newGame(String dungeonName, String gameMode) throws IllegalArgumentException {
<span class="fc" id="L112">        Boolean peaceful = gameMode.equalsIgnoreCase(&quot;peaceful&quot;);</span>
<span class="fc" id="L113">        Boolean standard = gameMode.equalsIgnoreCase(&quot;standard&quot;);</span>
<span class="fc" id="L114">        Boolean hard = gameMode.equalsIgnoreCase(&quot;hard&quot;);</span>
<span class="pc bpc" id="L115" title="1 of 6 branches missed.">        if (!peaceful &amp;&amp; !standard &amp;&amp; !hard) {</span>
<span class="fc" id="L116">            throw new IllegalArgumentException(&quot;invalid gamemode&quot;);</span>
        }
<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (!dungeons().contains(dungeonName)) {</span>
<span class="fc" id="L119">            throw new IllegalArgumentException(&quot;invalid dungeonName&quot;);</span>
        }
<span class="fc" id="L121">        List&lt;ItemResponse&gt; items = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L122">        List&lt;String&gt; buildables = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L123">        DungeonMania dungeonMania = new DungeonMania(gameMode, dungeonName);</span>
<span class="fc" id="L124">        JSONObject dungeon = null;</span>
<span class="fc" id="L125">        File f = new File(&quot;src/main/resources/dungeons/&quot; + dungeonName + &quot;.json&quot;);</span>
<span class="fc" id="L126">        String s = f.getAbsolutePath();</span>

        try {
<span class="fc" id="L129">            dungeon = new JSONObject(new JSONTokener(new FileReader(s)));</span>
<span class="nc" id="L130">        } catch (Exception e) {</span>
<span class="fc" id="L131">        }</span>
<span class="fc" id="L132">        JSONArray entities = dungeon.getJSONArray(&quot;entities&quot;);</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">        for (int i = 0; i &lt; entities.length(); i++) {</span>
<span class="fc" id="L134">            String type = entities.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="fc" id="L135">            int x = entities.getJSONObject(i).getInt(&quot;x&quot;);</span>
<span class="fc" id="L136">            int y = entities.getJSONObject(i).getInt(&quot;y&quot;);</span>
<span class="fc" id="L137">            Position pos = new Position(x, y, 0); // placeholder for layer</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">            if (type.equalsIgnoreCase(&quot;portal&quot;)) {</span>
<span class="fc" id="L139">                dungeonMania.createPortal(pos, type, entities.getJSONObject(i).getString(&quot;colour&quot;));</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">            } else if (type.equalsIgnoreCase(&quot;swamp_tile&quot;)) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">                if (entities.getJSONObject(i).has(&quot;movement_factor&quot;)) {</span>
<span class="nc" id="L142">                    int movement_factor = entities.getJSONObject(i).getInt(&quot;movement_factor&quot;);</span>
<span class="nc" id="L143">                    dungeonMania.addSwampTile(new SwampTile(new Position(x, y), movement_factor));</span>
<span class="nc" id="L144">                } else {</span>
<span class="nc" id="L145">                    dungeonMania.addSwampTile(new SwampTile(new Position(x, y)));</span>
                }
            } else {
<span class="fc" id="L148">                dungeonMania.createEntity(pos, type);</span>
            }
        }
<span class="fc bfc" id="L151" title="All 2 branches covered.">        for (int i = 0; i &lt; ThreadLocalRandom.current().nextInt(0,5); i++) {</span>
<span class="fc" id="L152">            dungeonMania.spawnSpider();</span>
        }
<span class="fc" id="L154">        JSONObject jsonGoalCondition = dungeon.getJSONObject(&quot;goal-condition&quot;);</span>
<span class="fc" id="L155">        dungeonMania.setGoal(GoalFactory.generate(jsonGoalCondition.toString()));</span>
<span class="fc" id="L156">        List&lt;EntityResponse&gt; entityResponses = dungeonMania.getEntityResponses();</span>
<span class="fc" id="L157">        dungeonMania.setId(Integer.toString(this.games.size() + 1));</span>
<span class="fc" id="L158">        this.games.add(dungeonMania);</span>
<span class="fc" id="L159">        this.loadedgame = dungeonMania;</span>
<span class="fc" id="L160">        return new DungeonResponse(dungeonMania.getId(), dungeonName, entityResponses, items, buildables,</span>
<span class="fc" id="L161">                GoalFactory.goalString(dungeonMania.getGoal()));</span>
    }

    /**
     * Saves a game given the name of the game instance
     * 
     * @param name
     * @return DungeonResponse
     * @throws IllegalArgumentException
     */
    public DungeonResponse saveGame(String name) throws IllegalArgumentException {
<span class="nc" id="L172">        int numSaves = allGames().size();</span>
<span class="nc" id="L173">        String difficulty = this.loadedgame.getDifficulty();</span>
<span class="nc" id="L174">        String mapName = this.loadedgame.getName();</span>
<span class="nc" id="L175">        JSONObject jsonObject = new JSONObject();</span>

<span class="nc" id="L177">        jsonObject.put(&quot;difficulty&quot;, difficulty);</span>
<span class="nc" id="L178">        jsonObject.put(&quot;mapName&quot;, mapName);</span>

<span class="nc" id="L180">        JSONArray entities = new JSONArray();</span>
<span class="nc" id="L181">        List&lt;Entity&gt; gameEntities = this.loadedgame.getEntities();</span>

<span class="nc bnc" id="L183" title="All 2 branches missed.">        for (Entity entity : gameEntities) {</span>
<span class="nc" id="L184">            JSONObject newEntity = new JSONObject();</span>
<span class="nc" id="L185">            int xPos = entity.getPos().getX();</span>
<span class="nc" id="L186">            int yPos = entity.getPos().getY();</span>
<span class="nc" id="L187">            String type = entity.getType();</span>
<span class="nc" id="L188">            newEntity.put(&quot;x&quot;, xPos);</span>
<span class="nc" id="L189">            newEntity.put(&quot;y&quot;, yPos);</span>
<span class="nc" id="L190">            newEntity.put(&quot;type&quot;, type);</span>
<span class="nc" id="L191">            entities.put(newEntity);</span>
<span class="nc" id="L192">        }</span>

<span class="nc" id="L194">        JSONArray inventory = new JSONArray();</span>
<span class="nc" id="L195">        List&lt;Entity&gt; gameItems = this.loadedgame.getItems();</span>

<span class="nc bnc" id="L197" title="All 2 branches missed.">        for (Entity item : gameItems) {</span>
<span class="nc" id="L198">            JSONObject newEntity = new JSONObject();</span>
<span class="nc" id="L199">            String type = item.getType();</span>
<span class="nc" id="L200">            newEntity.put(&quot;type&quot;, type);</span>
<span class="nc" id="L201">            inventory.put(newEntity);</span>
<span class="nc" id="L202">        }</span>

<span class="nc" id="L204">        jsonObject.put(&quot;entities&quot;, entities);</span>
<span class="nc" id="L205">        jsonObject.put(&quot;inventory&quot;, inventory);</span>

<span class="nc" id="L207">        Goal gameGoals = this.loadedgame.getGoal();</span>
<span class="nc" id="L208">        JSONObject goals = goalToJSON(gameGoals);</span>
<span class="nc" id="L209">        jsonObject.put(&quot;goal-condition&quot;, goals);</span>

<span class="nc" id="L211">        String conts = jsonObject.toString();</span>

        try {
<span class="nc" id="L214">            String pathname = &quot;src/main/resources/saves/&quot;;</span>
<span class="nc" id="L215">            String filename = difficulty + &quot;-&quot; + mapName + &quot;-&quot; + Integer.toString(numSaves) + &quot;-&quot; + &quot;.json&quot;;</span>
<span class="nc" id="L216">            File f = new File(pathname);</span>
<span class="nc" id="L217">            String absolutePathName = f.getAbsolutePath();</span>
<span class="nc" id="L218">            File save = new File(absolutePathName + &quot;/&quot; + filename);</span>
<span class="nc" id="L219">            save.createNewFile();</span>
<span class="nc" id="L220">            writeToFile(conts, absolutePathName + &quot;/&quot; + filename);</span>
<span class="nc" id="L221">        } catch (IOException e) {</span>

<span class="nc" id="L223">        }</span>

<span class="nc" id="L225">        String id = this.loadedgame.getId();</span>
<span class="nc" id="L226">        String gameName = this.loadedgame.getName();</span>
<span class="nc" id="L227">        List&lt;EntityResponse&gt; entityResponses = this.loadedgame.getEntityResponses();</span>
<span class="nc" id="L228">        List&lt;ItemResponse&gt; itemResponses = this.loadedgame.getItemResponses();</span>
<span class="nc" id="L229">        String goalString = GoalFactory.goalString(this.loadedgame.getGoal());</span>

<span class="nc" id="L231">        return new DungeonResponse(id, gameName, entityResponses, itemResponses, null, goalString);</span>
    }

    /**
     * Loads a specific game given the name of the game
     * 
     * @param name
     * @return DungeonResponse
     * @throws IllegalArgumentException
     */
    public DungeonResponse loadGame(String name) throws IllegalArgumentException {
        try {
<span class="nc" id="L243">            List&lt;String&gt; saves = allGames();</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (!saves.contains(name)) {</span>
<span class="nc" id="L245">                throw new IllegalArgumentException();</span>
            }
<span class="nc" id="L247">        } catch (IllegalArgumentException e) {</span>

<span class="nc" id="L249">        }</span>

<span class="nc" id="L251">        List&lt;ItemResponse&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L252">        List&lt;String&gt; buildables = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L254">        File f = new File(&quot;src/main/resources/saves/&quot; + name);</span>
<span class="nc" id="L255">        String s = f.getAbsolutePath();</span>
<span class="nc" id="L256">        JSONObject dungeon = null;</span>

        try {
<span class="nc" id="L259">            dungeon = new JSONObject(new JSONTokener(new FileReader(s)));</span>
<span class="nc" id="L260">        } catch (Exception e) {</span>
<span class="nc" id="L261">        }</span>

<span class="nc" id="L263">        String difficulty = dungeon.getString(&quot;difficulty&quot;);</span>
<span class="nc" id="L264">        String mapName = dungeon.getString(&quot;mapName&quot;);</span>
<span class="nc" id="L265">        DungeonMania dungeonMania = new DungeonMania(difficulty, mapName);</span>

<span class="nc" id="L267">        JSONArray entities = dungeon.getJSONArray(&quot;entities&quot;);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        for (int i = 0; i &lt; entities.length(); i++) {</span>
<span class="nc" id="L269">            String type = entities.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="nc" id="L270">            int x = entities.getJSONObject(i).getInt(&quot;x&quot;);</span>
<span class="nc" id="L271">            int y = entities.getJSONObject(i).getInt(&quot;y&quot;);</span>
<span class="nc" id="L272">            Position pos = new Position(x, y, 0); // placeholder for layer</span>
<span class="nc" id="L273">            dungeonMania.createEntity(pos, type);</span>
        }

<span class="nc" id="L276">        JSONArray inventory = dungeon.getJSONArray(&quot;inventory&quot;);</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">        for (int i = 0; i &lt; inventory.length(); i++) {</span>
<span class="nc" id="L278">            String type = inventory.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="nc" id="L279">            dungeonMania.AddItem(type);</span>
        }

<span class="nc" id="L282">        JSONObject jsonGoalCondition = dungeon.getJSONObject(&quot;goal-condition&quot;);</span>
<span class="nc" id="L283">        dungeonMania.setGoal(GoalFactory.generate(jsonGoalCondition.toString()));</span>
<span class="nc" id="L284">        List&lt;EntityResponse&gt; entityResponses = dungeonMania.getEntityResponses();</span>
<span class="nc" id="L285">        dungeonMania.setId(Integer.toString(this.games.size() + 1));</span>
<span class="nc" id="L286">        this.games.add(dungeonMania);</span>
<span class="nc" id="L287">        this.loadedgame = dungeonMania;</span>
<span class="nc" id="L288">        return new DungeonResponse(dungeonMania.getId(), mapName, entityResponses, items, buildables,</span>
<span class="nc" id="L289">                GoalFactory.goalString(dungeonMania.getGoal()));</span>

    }

    /**
     * Checks if a position is adjacent
     * 
     * @param e
     * @return boolean
     */
    public boolean RealisAdjacent(Position e) {
<span class="fc" id="L300">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc" id="L301">        List&lt;Direction&gt; directions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L302">        directions.add(Direction.UP);</span>
<span class="fc" id="L303">        directions.add(Direction.DOWN);</span>
<span class="fc" id="L304">        directions.add(Direction.LEFT);</span>
<span class="fc" id="L305">        directions.add(Direction.RIGHT);</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">        for (Direction d : directions) {</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">            if (dungeon.getCharacter().getPos().translateBy(d).equals(e)) {</span>
<span class="fc" id="L308">                return true;</span>
            }
<span class="fc" id="L310">        }</span>
<span class="fc" id="L311">        return false;</span>
    }

    public boolean RealisBomb(Position e) {
<span class="nc" id="L315">        DungeonMania dungeon = this.loadedgame;</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if(RealisAdjacent(e)) {</span>
<span class="nc" id="L317">            return true;</span>
        }
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (dungeon.getCharacter().getPos().translateBy(Direction.UP).translateBy(Direction.LEFT).equals(e)) {</span>
<span class="nc" id="L320">            return true;</span>
        }
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (dungeon.getCharacter().getPos().translateBy(Direction.UP).translateBy(Direction.RIGHT).equals(e)) {</span>
<span class="nc" id="L323">            return true;</span>
        }
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (dungeon.getCharacter().getPos().translateBy(Direction.DOWN).translateBy(Direction.LEFT).equals(e)) {</span>
<span class="nc" id="L326">            return true;</span>
        }
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (dungeon.getCharacter().getPos().translateBy(Direction.DOWN).translateBy(Direction.RIGHT).equals(e)) {</span>
<span class="nc" id="L329">            return true;</span>
        }
<span class="nc" id="L331">        return false;</span>
    }

    /**
     * Checks if a mercenary is adjacent to a given position
     * 
     * @param e
     * @return boolean
     */
    public boolean isMercenaryAdjacent(Position e) {
<span class="fc" id="L341">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc" id="L342">        List&lt;Direction&gt; directions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L343">        directions.add(Direction.UP);</span>
<span class="fc" id="L344">        directions.add(Direction.DOWN);</span>
<span class="fc" id="L345">        directions.add(Direction.LEFT);</span>
<span class="fc" id="L346">        directions.add(Direction.RIGHT);</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">        for (Direction d : directions) {</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">            if (dungeon.getCharacter().getPos().translateBy(d).translateBy(d).equals(e)) {</span>
<span class="nc" id="L349">                return true;</span>
            }
<span class="fc" id="L351">        }</span>
<span class="fc" id="L352">        return false;</span>
    }

    /**
     * Returns a list of all the games (saved and current)
     * 
     * @return List&lt;String&gt;
     */
    public List&lt;String&gt; allGames() {
<span class="fc" id="L361">        File f = new File(&quot;src/main/resources/&quot;);</span>
<span class="fc" id="L362">        String filepath = f.getAbsolutePath();</span>
<span class="fc" id="L363">        List&lt;String&gt; saves = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L364">        File savespath = new File(filepath + &quot;/saves/&quot;);</span>
<span class="nc" id="L365">        saves = Arrays.asList(savespath.list());</span>
<span class="nc" id="L366">        return saves;</span>
    }

    /**
     * Advances the game state by one tick also calculates what craftables the
     * character may have access to uses items if items have been used and moves the
     * character given the direction does battle, and checks if the game has ended
     * through the goal condition/ player death. and updates the state of all
     * entities in the game.
     * 
     * @param itemUsed
     * @param movementDirection
     * @return
     * @throws IllegalArgumentException
     * @throws InvalidActionException
     */
    public DungeonResponse tick(String itemUsed, Direction movementDirection)
            throws IllegalArgumentException, InvalidActionException {
        String Goalstring;
<span class="fc" id="L385">        Boolean isTimeTravelling = false;</span>
<span class="fc" id="L386">        tick++;</span>
<span class="fc" id="L387">        oldDirection.put(this.tick, movementDirection);</span>
<span class="fc" id="L388">        oldItem.put(this.tick, itemUsed);</span>
<span class="fc" id="L389">        DungeonMania currentGame = this.loadedgame;</span>
<span class="fc" id="L390">        List&lt;String&gt; buildables = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L391">        Entity RemovablePlayer = null;</span>
<span class="fc" id="L392">        List&lt;Entity&gt; removables = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L393">        Character updateCharacter = currentGame.getCharacter();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">        for (Entity olderPlayer: currentGame.getEntities()) {</span>
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">            if (olderPlayer instanceof OlderPlayer){</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">                if(TimeTravelDuration == 0) {</span>
<span class="nc" id="L397">                   RemovablePlayer = olderPlayer;</span>
                }
                else {
<span class="nc bnc" id="L400" title="All 2 branches missed.">                    if(TimeTravelDuration &gt; 0) {</span>
<span class="nc" id="L401">                        TimeTravelDuration--;</span>
                    }
<span class="nc" id="L403">                    ((OlderPlayer) olderPlayer).move(currentGame, ((OlderPlayer) olderPlayer).getItems(), this.oldDirection.get(tick - TimeTravelDuration));</span>
<span class="nc bnc" id="L404" title="All 4 branches missed.">                    if(itemUsed != null &amp;&amp; oldItem.get(this.tick - TimeTravelDuration) != null) {</span>
<span class="nc" id="L405">                        DungeonResponse d = ((OlderPlayer) olderPlayer).processItem(oldItem.get(this.tick - TimeTravelDuration), currentGame, currentGame.getBuildables());</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                        if(d != null) {</span>
<span class="nc" id="L407">                            return d;</span>
                        }
                    }
<span class="nc bnc" id="L410" title="All 2 branches missed.">                    for (Entity firstentity: currentGame.getEntities()) {</span>
<span class="nc" id="L411">                        Entity toRemove = null;</span>
<span class="nc bnc" id="L412" title="All 4 branches missed.">                        if (firstentity instanceof MovingEntity &amp;&amp; firstentity.getPos().equals(olderPlayer.getPos())) {</span>
<span class="nc" id="L413">                            Entity e = ((OlderPlayer) olderPlayer).doBattle((OlderPlayer) olderPlayer, (MovingEntity) firstentity, currentGame, removables);</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">                            if( e != null) {</span>
<span class="nc" id="L415">                                removables.add(e);</span>
                            }
                        }
<span class="nc bnc" id="L418" title="All 6 branches missed.">                        if(firstentity instanceof Character &amp;&amp; !(firstentity instanceof OlderPlayer) &amp;&amp; firstentity.getPos().translateBy(movementDirection).equals(olderPlayer.getPos())){</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                            while(toRemove == null) {</span>
<span class="nc" id="L420">                                toRemove = ((OlderPlayer) olderPlayer).OlderPlayerBattle(currentGame, (Character) firstentity);</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                                if(toRemove != null) {</span>
<span class="nc" id="L422">                                    removables.add(toRemove);</span>
                                }
                            }
                        }
<span class="nc" id="L426">                    }</span>
                }
            }
<span class="fc" id="L429">        }</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">        if(itemUsed != null) {</span>
<span class="fc" id="L431">            DungeonResponse d = updateCharacter.processItem(itemUsed, currentGame, currentGame.getBuildables());</span>
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">            if(d != null) {</span>
<span class="fc" id="L433">                return d;</span>
            }
        }
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">        if(RemovablePlayer != null) {</span>
<span class="nc" id="L437">            currentGame.removeEntity(RemovablePlayer);</span>
        }
<span class="pc bpc" id="L439" title="1 of 2 branches missed.">        for (Entity entity: removables) {</span>
<span class="nc" id="L440">            currentGame.removeEntity(entity);</span>
<span class="nc" id="L441">        }</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">        if (!updateCharacter.getInBattle()) {</span>
<span class="fc" id="L443">            updateCharacter.move(currentGame,currentGame.getItems(), movementDirection);</span>
<span class="fc" id="L444">            currentGame.setCharacter(updateCharacter);</span>
<span class="fc" id="L445">            currentGame.updateEntities(updateCharacter);</span>
        }
<span class="fc" id="L447">        CheckBow();</span>
<span class="fc" id="L448">        CheckShield();</span>
<span class="fc" id="L449">        Goal goal = currentGame.getGoal();</span>
<span class="fc" id="L450">        List&lt;Entity&gt; toRemove = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L451">        updateCharacter.updateChar();</span>
<span class="pc bpc" id="L452" title="1 of 4 branches missed.">        if (tick % 30 == 0 &amp;&amp; tick != 0) {</span>
<span class="fc" id="L453">            currentGame.spawnMercenary();</span>
        }
<span class="pc bpc" id="L455" title="2 of 6 branches missed.">        if (tick % 50 == 0 &amp;&amp; tick != 0 &amp;&amp; currentGame.getDifficulty().equalsIgnoreCase(&quot;hard&quot;)) {</span>
<span class="nc" id="L456">            currentGame.spawnHydra();</span>
        }
 
        
<span class="fc" id="L460">        List&lt;Entity&gt; zombieToastSpawners = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L461" title="All 2 branches covered.">        for (Entity entity : currentGame.getEntities()) {</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">            if (entity instanceof MovingEntity) {</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">                if (entity instanceof Mercenary) {</span>
<span class="fc" id="L464">                    int ticksLeftOnBribe = ((Mercenary) entity).getTicksLeftOnBribe();</span>
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">                    if (ticksLeftOnBribe &gt; 1) {</span>
<span class="nc" id="L466">                        ((Mercenary) entity).setTicksLeftOnBribe(ticksLeftOnBribe - 1);</span>
<span class="pc bpc" id="L467" title="1 of 2 branches missed.">                    } else if (ticksLeftOnBribe == 1) {</span>
<span class="nc" id="L468">                        ((Mercenary) entity).setTicksLeftOnBribe(ticksLeftOnBribe - 1);</span>
<span class="nc" id="L469">                        updateCharacter.removeAlly((MovingEntity) entity);</span>
<span class="nc" id="L470">                        ((Mercenary) entity).setIsBribed(false);</span>
                    }
                }
<span class="pc bpc" id="L473" title="3 of 4 branches missed.">                if (updateCharacter.getInBattle() &amp;&amp; !((MovingEntity) entity).getInBattle()) {</span>
<span class="nc" id="L474">                    ((MovingEntity) entity).move(currentGame);</span>
                }
<span class="pc bpc" id="L476" title="3 of 4 branches missed.">                if (updateCharacter.getInBattle() &amp;&amp; entity instanceof Mercenary</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">                        &amp;&amp; !((MovingEntity) entity).getInBattle()) {</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">                    if (isMercenaryAdjacent(entity.getPos())) {</span>
<span class="nc" id="L479">                        ((MovingEntity) entity).move(currentGame);</span>
                    }
                }
                
<span class="pc bpc" id="L483" title="2 of 4 branches missed.">                if (!updateCharacter.getInBattle() &amp;&amp; !((MovingEntity) entity).getInBattle()) {</span>
<span class="fc" id="L484">                    ((MovingEntity) entity).move(currentGame);</span>
<span class="fc bfc" id="L485" title="All 4 branches covered.">                    if (((MovingEntity) entity).isHostile() &amp;&amp; updateCharacter.getPos().equals(entity.getPos())</span>
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">                            &amp;&amp; !currentGame.getDifficulty().equalsIgnoreCase(&quot;peaceful&quot;)) {</span>
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">                        if (!loadedgame.getCharacter().getisInvisible()) {</span>
<span class="fc" id="L488">                            updateCharacter.setInBattle(true);</span>
<span class="fc" id="L489">                            ((MovingEntity) entity).setInBattle(true);</span>
                        }
                    }
                }
                
<span class="pc bpc" id="L494" title="1 of 4 branches missed.">                while (updateCharacter.getInBattle() &amp;&amp; ((MovingEntity) entity).getInBattle()</span>
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">                        &amp;&amp; ((MovingEntity) entity).isHostile()) {</span>
<span class="fc" id="L496">                    Entity removable = updateCharacter.doBattle(updateCharacter, (MovingEntity) entity, currentGame, toRemove);</span>
<span class="fc bfc" id="L497" title="All 2 branches covered.">                    if (removable != null){</span>
<span class="fc" id="L498">                        toRemove.add(removable);</span>
                    } 
<span class="fc" id="L500">                }</span>
            }

<span class="fc bfc" id="L503" title="All 2 branches covered.">            if (entity instanceof CollectableEntities) {</span>
<span class="fc bfc" id="L504" title="All 2 branches covered.">                if (updateCharacter.getPos().equals(entity.getPos())) {</span>
<span class="fc" id="L505">                    toRemove.add(entity);</span>
<span class="fc" id="L506">                    currentGame.AddItem(entity.getType());</span>
                }
            }
<span class="fc bfc" id="L509" title="All 2 branches covered.">            if (entity instanceof StaticEntity) {</span>
<span class="fc bfc" id="L510" title="All 2 branches covered.">                if (entity instanceof FloorSwitch) {</span>
<span class="fc bfc" id="L511" title="All 2 branches covered.">                    if (((FloorSwitch) entity).checkTriggered(currentGame.getEntities())) {</span>
<span class="fc" id="L512">                        ((FloorSwitch) entity).setisTriggered(true);</span>
                    }
                }
<span class="fc bfc" id="L515" title="All 2 branches covered.">                if (entity instanceof ZombieToastSpawner) {</span>
<span class="fc" id="L516">                    ((ZombieToastSpawner) entity)</span>
<span class="fc" id="L517">                            .setTicksSinceSpawn(((ZombieToastSpawner) entity).getTicksSinceSpawn() + 1);</span>
<span class="fc bfc" id="L518" title="All 2 branches covered.">                    Boolean Standardspawn = ((ZombieToastSpawner) entity).getTicksSinceSpawn() % 20 == 0;</span>
<span class="fc" id="L519">                    Boolean IsOnHard = currentGame.getDifficulty().equalsIgnoreCase(&quot;hard&quot;);</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">                    Boolean HardSpawn = ((ZombieToastSpawner) entity).getTicksSinceSpawn() % 15 == 0;</span>
<span class="pc bpc" id="L521" title="2 of 8 branches missed.">                    if ((Standardspawn &amp;&amp; !IsOnHard) || (HardSpawn &amp;&amp; IsOnHard)) {</span>
<span class="fc" id="L522">                        zombieToastSpawners.add(entity);</span>
<span class="fc" id="L523">                        ((ZombieToastSpawner) entity).setTicksSinceSpawn(0);</span>
                    }
                }
            }
<span class="fc" id="L527">        }</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">        if (zombieToastSpawners.size() &gt; 0) {</span>
<span class="fc bfc" id="L529" title="All 2 branches covered.">            for (Entity zombie : zombieToastSpawners) {</span>
<span class="fc" id="L530">                currentGame.spawnZombie(((ZombieToastSpawner) zombie).getPos());</span>
<span class="fc" id="L531">            }</span>
        }

<span class="fc bfc" id="L534" title="All 2 branches covered.">        for (Entity entity : toRemove) {</span>
<span class="fc" id="L535">            currentGame.removeEntity(entity);</span>
<span class="fc" id="L536">        }</span>

<span class="fc" id="L538">        String id = currentGame.getId();</span>
<span class="fc" id="L539">        String name = currentGame.getName();</span>
<span class="fc" id="L540">        List&lt;EntityResponse&gt; e = currentGame.getEntityResponses();</span>
<span class="fc" id="L541">        List&lt;ItemResponse&gt; i = currentGame.getItemResponses();</span>
<span class="fc bfc" id="L542" title="All 2 branches covered.">        if (goal.isComplete(currentGame)) {</span>
<span class="fc" id="L543">            Goalstring = &quot;&quot;;</span>
<span class="fc" id="L544">            this.loadedgame = null;</span>
        } else {
<span class="fc" id="L546">            Goalstring = GoalFactory.goalString(currentGame.getGoal());</span>
<span class="fc" id="L547">            RewindGame();</span>
        }
        
<span class="fc" id="L550">        return new DungeonResponse(id, name, e, i, currentGame.getBuildables(), Goalstring);</span>

    }

    /**
     * Interacts with a given entity Id
     * 
     * @param entityId
     * @return DungeonResponse
     * @throws IllegalArgumentException
     * @throws InvalidActionException
     */
    public DungeonResponse interact(String entityId) throws IllegalArgumentException, InvalidActionException {
<span class="fc" id="L563">        DungeonMania loadedgame = this.loadedgame;</span>
<span class="fc" id="L564">        Entity interactableEntity = null;</span>
<span class="fc bfc" id="L565" title="All 2 branches covered.">        for (Entity entity : loadedgame.getEntities()) {</span>
<span class="fc bfc" id="L566" title="All 2 branches covered.">            if (entity.getId().equals(entityId)) {</span>
<span class="fc" id="L567">                interactableEntity = entity;</span>
            }
<span class="fc" id="L569">        }</span>
<span class="fc bfc" id="L570" title="All 4 branches covered.">        if (!(interactableEntity instanceof Mercenary) &amp;&amp; !(interactableEntity instanceof ZombieToastSpawner)) {</span>
<span class="fc" id="L571">            throw new IllegalArgumentException(&quot;not a mercenary or Zombie Spawner&quot;);</span>
        }
<span class="fc" id="L573">        Entity bow = null;</span>
<span class="fc" id="L574">        Entity sword = null;</span>
<span class="fc" id="L575">        Entity treasure = null;</span>
<span class="fc" id="L576">        Entity one_ring = null;</span>
<span class="fc" id="L577">        Entity sceptre = null;</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">        for (Entity item : loadedgame.getItems()) {</span>
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">            if (item instanceof Bow) {</span>
<span class="nc" id="L580">                bow = item;</span>
<span class="pc bpc" id="L581" title="1 of 4 branches missed.">            } else if (item instanceof TreasureEntity || item instanceof SunStone) {</span>
<span class="fc" id="L582">                treasure = item;</span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">            } else if (item instanceof SwordEntity) {</span>
<span class="fc" id="L584">                sword = item;</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">            } else if (item instanceof TheOneRingEntity) {</span>
<span class="nc" id="L586">                one_ring = item;</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">            } else if (item instanceof Sceptre) {</span>
<span class="nc" id="L588">                sceptre = item;</span>
            }
<span class="fc" id="L590">        }</span>

<span class="pc bpc" id="L592" title="1 of 4 branches missed.">        Boolean bribeMPossible = (treasure != null) || (sceptre != null);</span>
<span class="pc bpc" id="L593" title="2 of 4 branches missed.">        Boolean bribeAPossible = (one_ring != null) || (sceptre != null);</span>

<span class="fc bfc" id="L595" title="All 4 branches covered.">        if (!bribeMPossible &amp;&amp; interactableEntity instanceof Mercenary) {</span>
<span class="fc" id="L596">            throw new InvalidActionException(&quot;insufficient material to bribe&quot;);</span>
        }
<span class="pc bpc" id="L598" title="2 of 4 branches missed.">        if (!bribeAPossible &amp;&amp; interactableEntity instanceof Assassin) {</span>
<span class="nc" id="L599">            throw new InvalidActionException(&quot;insufficient material to bribe&quot;);</span>
        }
<span class="fc bfc" id="L601" title="All 2 branches covered.">        if (interactableEntity instanceof Mercenary) {</span>
<span class="pc bpc" id="L602" title="2 of 4 branches missed.">            if (!isMercenaryAdjacent(interactableEntity.getPos()) &amp;&amp; !RealisAdjacent(interactableEntity.getPos())) {</span>
<span class="nc" id="L603">                throw new InvalidActionException(&quot;not cardinally adjacent within 2 squares&quot;);</span>
            }
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">            if (sceptre != null) {</span>
<span class="nc" id="L606">                ((Mercenary) interactableEntity).setTicksLeftOnBribe(10);</span>
<span class="nc" id="L607">                Character updateCharacter = loadedgame.getCharacter();</span>
<span class="nc" id="L608">                updateCharacter.addAlly((Mercenary) interactableEntity);</span>
<span class="nc" id="L609">                loadedgame.setCharacter(updateCharacter);</span>
<span class="nc" id="L610">                ((Mercenary) interactableEntity).setIsBribed(true);</span>
<span class="nc" id="L611">            } else {</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">                if (interactableEntity instanceof Assassin) {</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">                    if (one_ring != null) {</span>
<span class="nc" id="L614">                        loadedgame.removeItem(one_ring);</span>
<span class="nc" id="L615">                        Character updateCharacter = loadedgame.getCharacter();</span>
<span class="nc" id="L616">                        updateCharacter.addAlly((Assassin) interactableEntity);</span>
<span class="nc" id="L617">                        loadedgame.setCharacter(updateCharacter);</span>
<span class="nc" id="L618">                        ((Assassin) interactableEntity).setIsBribed(true);</span>
<span class="nc" id="L619">                    }</span>
                } else {
<span class="pc bpc" id="L621" title="3 of 4 branches missed.">                    if (treasure instanceof TreasureEntity || treasure instanceof SunStone) {</span>
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">                        if (treasure instanceof TreasureEntity) {</span>
<span class="fc" id="L623">                            loadedgame.removeItem(treasure);</span>
                        }
<span class="fc" id="L625">                        Character updateCharacter = loadedgame.getCharacter();</span>
<span class="fc" id="L626">                        updateCharacter.addAlly((Mercenary) interactableEntity);</span>
<span class="fc" id="L627">                        loadedgame.setCharacter(updateCharacter);</span>
<span class="fc" id="L628">                        ((Mercenary) interactableEntity).setIsBribed(true);</span>
                    }
                }
            }
        }
<span class="fc bfc" id="L633" title="All 2 branches covered.">        if (interactableEntity instanceof ZombieToastSpawner) {</span>
<span class="fc bfc" id="L634" title="All 2 branches covered.">            if (!RealisAdjacent(interactableEntity.getPos())) {</span>
<span class="fc" id="L635">                throw new InvalidActionException(&quot;not cardianally adjacent&quot;);</span>
            }
<span class="pc bpc" id="L637" title="3 of 4 branches missed.">            if (sword == null &amp;&amp; bow == null) {</span>
<span class="nc" id="L638">                throw new InvalidActionException(&quot;no weapon&quot;);</span>
            }
<span class="pc bpc" id="L640" title="4 of 6 branches missed.">            if (RealisAdjacent(interactableEntity.getPos()) &amp;&amp; (sword != null || bow != null)) {</span>
<span class="fc" id="L641">                loadedgame.removeEntity(interactableEntity);</span>
            }
        }
<span class="fc" id="L644">        return new DungeonResponse(loadedgame.getId(), loadedgame.getName(), loadedgame.getEntityResponses(),</span>
<span class="fc" id="L645">                loadedgame.getItemResponses(), null, GoalFactory.goalString(loadedgame.getGoal()));</span>
    }

    /**
     * Checks if the character can craft a bow
     * 
     * @return boolean
     */
    public Boolean CheckBow() {
<span class="fc" id="L654">        int wood = 0;</span>
<span class="fc" id="L655">        int arrows = 0;</span>
<span class="fc" id="L656">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L657" title="All 2 branches covered.">        for (Entity item : dungeon.getItems()) {</span>
<span class="fc bfc" id="L658" title="All 2 branches covered.">            if (item.getType().equals(&quot;wood&quot;)) {</span>
<span class="fc" id="L659">                wood++;</span>
            }
<span class="fc bfc" id="L661" title="All 2 branches covered.">            if (item.getType().equals(&quot;arrow&quot;)) {</span>
<span class="fc" id="L662">                arrows++;</span>
            }
<span class="fc" id="L664">        }</span>
<span class="fc bfc" id="L665" title="All 4 branches covered.">        if (wood &gt;= 1 &amp;&amp; arrows &gt;= 3) {</span>
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">            if (!dungeon.getBuildables().contains(&quot;bow&quot;)) {</span>
<span class="fc" id="L667">                dungeon.addToBuildableEntities(&quot;bow&quot;);</span>
            }
<span class="fc" id="L669">            return true;</span>
        }
<span class="fc" id="L671">        return false;</span>
    }

    /**
     * Checks if the character can craft a sceptre
     * 
     * @return boolean
     */
    public Boolean CheckSceptre() {
<span class="nc" id="L680">        int wood = 0;</span>
<span class="nc" id="L681">        int arrows = 0;</span>
<span class="nc" id="L682">        int keys = 0;</span>
<span class="nc" id="L683">        int treasure = 0;</span>
<span class="nc" id="L684">        int stone = 0;</span>
<span class="nc" id="L685">        DungeonMania dungeon = this.loadedgame;</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">        for (Entity item : dungeon.getItems()) {</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            if (item.getType().equals(&quot;wood&quot;)) {</span>
<span class="nc" id="L688">                wood++;</span>
            }
<span class="nc bnc" id="L690" title="All 2 branches missed.">            if (item.getType().equals(&quot;arrow&quot;)) {</span>
<span class="nc" id="L691">                arrows++;</span>
            }
<span class="nc bnc" id="L693" title="All 2 branches missed.">            if (item.getType().equals(&quot;keys&quot;)) {</span>
<span class="nc" id="L694">                keys++;</span>
            }
<span class="nc bnc" id="L696" title="All 2 branches missed.">            if (item.getType().equals(&quot;treasure&quot;)) {</span>
<span class="nc" id="L697">                treasure++;</span>
            }
<span class="nc bnc" id="L699" title="All 2 branches missed.">            if (item.getType().equals(&quot;sun_stone&quot;)) {</span>
<span class="nc" id="L700">                stone++;</span>
            }
<span class="nc" id="L702">        }</span>
<span class="nc bnc" id="L703" title="All 10 branches missed.">        if ((wood &gt;= 1 || arrows &gt;= 2) &amp;&amp; (keys &gt;= 1 || treasure &gt;= 1) &amp;&amp; stone &gt;= 1) {</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">            if (!dungeon.getBuildables().contains(&quot;sceptre&quot;)) {</span>
<span class="nc" id="L705">                dungeon.addToBuildableEntities(&quot;sceptre&quot;);</span>
            }
<span class="nc" id="L707">            return true;</span>
        }
<span class="nc" id="L709">        return false;</span>
    }

    /**
     * Checks if the character can craft a sceptre
     * 
     * @return boolean
     */
    public Boolean CheckMidnightArmour() {
<span class="nc" id="L718">        boolean hasArmour = false;</span>
<span class="nc" id="L719">        boolean hasZombie = false;</span>
<span class="nc" id="L720">        int stone = 0;</span>
<span class="nc" id="L721">        DungeonMania dungeon = this.loadedgame;</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">        for (Entity item : dungeon.getItems()) {</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">            if (item.getType().equals(&quot;armour&quot;)) {</span>
<span class="nc" id="L724">                hasArmour = true;</span>
            }
<span class="nc bnc" id="L726" title="All 2 branches missed.">            if (item.getType().equals(&quot;sun_stone&quot;)) {</span>
<span class="nc" id="L727">                stone++;</span>
            }
<span class="nc" id="L729">        }</span>
<span class="nc bnc" id="L730" title="All 2 branches missed.">        for (Entity entity : dungeon.getEntities()) {</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">            if (entity instanceof ZombieToast) {</span>
<span class="nc" id="L732">                hasZombie = true;</span>
            }
<span class="nc" id="L734">        }</span>
<span class="nc bnc" id="L735" title="All 6 branches missed.">        if (hasArmour &amp;&amp; stone &gt;= 1 &amp;&amp; !hasZombie) {</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">            if (!dungeon.getBuildables().contains(&quot;midnight_armour&quot;)) {</span>
<span class="nc" id="L737">                dungeon.addToBuildableEntities(&quot;midnight_armour&quot;);</span>
            }
<span class="nc" id="L739">            return true;</span>
        }
<span class="nc" id="L741">        return false;</span>
    }

    /**
     * Checks if the character can craft a shield
     * 
     * @return boolean
     */
    
    public Boolean CheckShield() {
<span class="fc" id="L751">        int keys = 0;</span>
<span class="fc" id="L752">        int wood = 0;</span>
<span class="fc" id="L753">        int treasure = 0;</span>
<span class="fc" id="L754">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L755" title="All 2 branches covered.">        for (Entity item : dungeon.getItems()) {</span>
<span class="fc bfc" id="L756" title="All 2 branches covered.">            if (item.getType().equals(&quot;wood&quot;)) {</span>
<span class="fc" id="L757">                wood++;</span>
            }
<span class="pc bpc" id="L759" title="1 of 4 branches missed.">            if (item.getType().equals(&quot;key&quot;) &amp;&amp; ((KeyEntity) item).getIsUsed()) {</span>
<span class="fc" id="L760">                keys++;</span>
            }

<span class="fc bfc" id="L763" title="All 2 branches covered.">            if (item.getType().equals(&quot;treasure&quot;)) {</span>
<span class="fc" id="L764">                treasure++;</span>
            }
<span class="fc" id="L766">        }</span>
<span class="fc bfc" id="L767" title="All 6 branches covered.">        if ((treasure &gt;= 1 || keys &gt;= 1) &amp;&amp; wood &gt;= 1) {</span>
<span class="fc bfc" id="L768" title="All 2 branches covered.">            if (!dungeon.getBuildables().contains(&quot;shield&quot;)) {</span>
<span class="fc" id="L769">                dungeon.addToBuildableEntities(&quot;shield&quot;);</span>
            }
<span class="fc" id="L771">            return true;</span>
        }
<span class="fc" id="L773">        return false;</span>
    }

    /**
     * Builds a bow given the string of the type throws error if the desired craft
     * is not bow or shield
     * 
     * @param buildable
     * @return DungeonResponse
     * @throws IllegalArgumentException
     * @throws InvalidActionException
     */
    public DungeonResponse build(String buildable) throws IllegalArgumentException, InvalidActionException {
<span class="fc" id="L786">        List&lt;String&gt; builds = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L787">        builds.add(&quot;bow&quot;);</span>
<span class="fc" id="L788">        builds.add(&quot;shield&quot;);</span>
<span class="fc" id="L789">        builds.add(&quot;midnight_armour&quot;);</span>
<span class="fc" id="L790">        builds.add(&quot;sceptre&quot;);</span>
<span class="fc bfc" id="L791" title="All 2 branches covered.">        if (!builds.contains(buildable)) {</span>
<span class="fc" id="L792">            throw new IllegalArgumentException();</span>
        }
<span class="fc" id="L794">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L795" title="All 2 branches covered.">        if (buildable.equals(&quot;bow&quot;)) {</span>
<span class="pc bpc" id="L796" title="1 of 2 branches missed.">            if (CheckBow()) {</span>
<span class="fc" id="L797">                dungeon.addBuildable(&quot;bow&quot;);</span>
            } else {
<span class="nc" id="L799">                throw new InvalidActionException(&quot;cannot build bow&quot;);</span>
            }
        }

<span class="fc bfc" id="L803" title="All 2 branches covered.">        if (buildable.equals(&quot;shield&quot;)) {</span>
<span class="pc bpc" id="L804" title="1 of 2 branches missed.">            if (CheckShield()) {</span>
<span class="fc" id="L805">                dungeon.addBuildable(&quot;shield&quot;);</span>
            } else {
<span class="nc" id="L807">                throw new InvalidActionException(&quot;cannot build shield&quot;);</span>
            }
        }

<span class="pc bpc" id="L811" title="1 of 2 branches missed.">        if (buildable.equals(&quot;midnight_armour&quot;)) {</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">            if (CheckMidnightArmour()) {</span>
<span class="nc" id="L813">                dungeon.addBuildable(&quot;midnight_armour&quot;);</span>
            } else {
<span class="nc" id="L815">                throw new InvalidActionException(&quot;cannot build midnight armour&quot;);</span>
            }
        }

<span class="pc bpc" id="L819" title="1 of 2 branches missed.">        if (buildable.equals(&quot;sceptre&quot;)) {</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">            if (CheckSceptre()) {</span>
<span class="nc" id="L821">                dungeon.addBuildable(&quot;sceptre&quot;);</span>
            } else {
<span class="nc" id="L823">                throw new InvalidActionException(&quot;cannot build sceptre&quot;);</span>
            }
        }

<span class="fc" id="L827">        return new DungeonResponse(loadedgame.getId(), loadedgame.getName(), loadedgame.getEntityResponses(),</span>
<span class="fc" id="L828">                loadedgame.getItemResponses(), loadedgame.getBuildables(),</span>
<span class="fc" id="L829">                GoalFactory.goalString(loadedgame.getGoal()));</span>
    }

    public DungeonResponse generateDungeon(int xStart, int yStart, int xEnd, int yEnd, String gameMode)
            throws IllegalArgumentException {
        // checking gameMode
<span class="fc" id="L835">        Boolean peaceful = gameMode.equalsIgnoreCase(&quot;peaceful&quot;);</span>
<span class="fc" id="L836">        Boolean standard = gameMode.equalsIgnoreCase(&quot;standard&quot;);</span>
<span class="fc" id="L837">        Boolean hard = gameMode.equalsIgnoreCase(&quot;hard&quot;);</span>
<span class="pc bpc" id="L838" title="5 of 6 branches missed.">        if (!peaceful &amp;&amp; !standard &amp;&amp; !hard) {</span>
<span class="nc" id="L839">            throw new IllegalArgumentException(&quot;invalid gamemode&quot;);</span>
        }

<span class="fc" id="L842">        Position start = new Position(xStart, yStart);</span>
<span class="fc" id="L843">        Position end = new Position(xEnd, yEnd);</span>
<span class="fc" id="L844">        List&lt;List&lt;Boolean&gt;&gt; grid = Prims.generate(50, 50, start, end);</span>
<span class="fc" id="L845">        DungeonMania dungeonMania = new DungeonMania(gameMode, &quot;RandomDungeon&quot;);</span>

<span class="fc" id="L847">        dungeonMania.createEntity(start, &quot;player&quot;);</span>
<span class="fc" id="L848">        dungeonMania.createEntity(end, &quot;exit&quot;);</span>

<span class="fc bfc" id="L850" title="All 2 branches covered.">        for (int i = 0; i &lt; 50; i++) {</span>
<span class="fc bfc" id="L851" title="All 2 branches covered.">            for (int j = 0; j &lt; 50; j++) {</span>
<span class="fc bfc" id="L852" title="All 2 branches covered.">                if (!grid.get(i).get(j)) {</span>
<span class="fc" id="L853">                    Position pos = new Position(i, j);</span>
<span class="fc" id="L854">                    dungeonMania.createEntity(pos, &quot;wall&quot;);</span>
                }
            }
        }

<span class="fc" id="L859">        JSONObject jsonGoalCondition = new JSONObject(&quot;{\&quot;goal\&quot;: \&quot;exit\&quot;}&quot;);</span>
<span class="fc" id="L860">        dungeonMania.setGoal(GoalFactory.generate(jsonGoalCondition.toString()));</span>
<span class="fc" id="L861">        List&lt;EntityResponse&gt; entityResponses = dungeonMania.getEntityResponses();</span>
<span class="fc" id="L862">        dungeonMania.setId(Integer.toString(this.games.size() + 1));</span>
<span class="fc" id="L863">        this.games.add(dungeonMania);</span>
<span class="fc" id="L864">        this.loadedgame = dungeonMania;</span>
<span class="fc" id="L865">        return new DungeonResponse(dungeonMania.getId(), &quot;RandomDungeon&quot;, entityResponses, new ArrayList&lt;&gt;(),</span>
<span class="fc" id="L866">                new ArrayList&lt;&gt;(), GoalFactory.goalString(dungeonMania.getGoal()));</span>
    }

    /**
     * Writes the given contents to a given filename
     * 
     * @param conts
     * @param filename
     */
    public void writeToFile(String conts, String filename) {
        try {
<span class="fc" id="L877">            FileWriter fw = new FileWriter(filename);</span>
<span class="fc" id="L878">            fw.write(conts);</span>
<span class="fc" id="L879">            fw.close();</span>
<span class="nc" id="L880">        } catch (IOException e) {</span>

<span class="fc" id="L882">        }</span>
<span class="fc" id="L883">    }</span>
    public DungeonResponse rewind(int ticks)
    throws IllegalArgumentException {
<span class="nc" id="L886">        List&lt;ItemResponse&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L887">        List&lt;String&gt; buildables = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L888">        TimeTravelDuration = ticks;</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">        if (this.tick &lt; ticks) {</span>
<span class="nc" id="L890">            ticks = this.tick;</span>
        }
<span class="nc" id="L892">        File f = new File(&quot;src/main/resources/rewindsaves/&quot; + this.loadedgame.getDifficulty() + &quot;-&quot; + loadedgame.getName() + &quot;-&quot; + Integer.toString(tick-ticks) + &quot;-&quot; + &quot;.json&quot; );</span>
<span class="nc" id="L893">        String s = f.getAbsolutePath();</span>
<span class="nc" id="L894">        JSONObject dungeon = null;</span>

        try {
<span class="nc" id="L897">            dungeon = new JSONObject(new JSONTokener(new FileReader(s)));</span>
<span class="nc" id="L898">        } catch (Exception e) {</span>
<span class="nc" id="L899">        }</span>

<span class="nc" id="L901">        String difficulty = dungeon.getString(&quot;difficulty&quot;);</span>
<span class="nc" id="L902">        String mapName = dungeon.getString(&quot;mapName&quot;);</span>
<span class="nc" id="L903">        DungeonMania dungeonMania = new DungeonMania(difficulty, mapName);</span>
<span class="nc" id="L904">        OlderPlayer player = null;</span>
<span class="nc" id="L905">        JSONArray entities = dungeon.getJSONArray(&quot;entities&quot;);</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">        for (int i = 0; i &lt; entities.length(); i++) {</span>
<span class="nc" id="L907">            String type = entities.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="nc" id="L908">            int x = entities.getJSONObject(i).getInt(&quot;x&quot;);</span>
<span class="nc" id="L909">            int y = entities.getJSONObject(i).getInt(&quot;y&quot;);</span>
<span class="nc" id="L910">            Position pos = new Position(x, y, 0); // placeholder for layer</span>
<span class="nc" id="L911">            dungeonMania.createEntity(pos, type);</span>
        }
<span class="nc" id="L913">        dungeonMania.setCharacter(this.loadedgame.getCharacter());</span>
<span class="nc" id="L914">        dungeonMania.createEntity(dungeonMania.getCharacter().getPos(), dungeonMania.getCharacter().getType());</span>
        
<span class="nc" id="L916">        JSONArray inventory = dungeon.getJSONArray(&quot;inventory&quot;);</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">        for (int i = 0; i &lt; inventory.length(); i++) {</span>
<span class="nc" id="L918">            String type = inventory.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">            if(!type.equalsIgnoreCase(&quot;time_turner&quot;)) {</span>
<span class="nc bnc" id="L920" title="All 2 branches missed.">                for(Entity entity: dungeonMania.getEntities()) {</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">                    if (entity instanceof OlderPlayer) {</span>
<span class="nc" id="L922">                    ((OlderPlayer) entity).AddItem(type, loadedgame);</span>
                    }
<span class="nc" id="L924">                }</span>
            }
        }



<span class="nc" id="L930">        JSONObject jsonGoalCondition = dungeon.getJSONObject(&quot;goal-condition&quot;);</span>
<span class="nc" id="L931">        dungeonMania.setGoal(GoalFactory.generate(jsonGoalCondition.toString()));</span>
<span class="nc" id="L932">        List&lt;EntityResponse&gt; entityResponses = dungeonMania.getEntityResponses();</span>
<span class="nc" id="L933">        dungeonMania.setId(Integer.toString(this.games.size() + 1));</span>
<span class="nc" id="L934">        this.games.add(dungeonMania);</span>
<span class="nc" id="L935">        this.loadedgame = dungeonMania;</span>
<span class="nc" id="L936">        return new DungeonResponse(dungeonMania.getId(), mapName, entityResponses, items, buildables,</span>
<span class="nc" id="L937">                GoalFactory.goalString(dungeonMania.getGoal()));</span>
    }
    
    /**
     * Turns a given goal the a json file
     * 
     * @param goal
     * @return JSONObject
     */
    public JSONObject goalToJSON(Goal goal) {
<span class="fc" id="L947">        JSONObject jsonObject = new JSONObject();</span>

<span class="fc" id="L949">        jsonObject.put(&quot;goal&quot;, goal.getName());</span>

<span class="fc bfc" id="L951" title="All 2 branches covered.">        if (goal instanceof GoalComposite) {</span>
<span class="fc" id="L952">            List&lt;Goal&gt; subgoals = ((GoalComposite) goal).getSubgoals();</span>
<span class="fc" id="L953">            JSONArray array = new JSONArray();</span>
<span class="fc bfc" id="L954" title="All 2 branches covered.">            for (Goal subgoal : subgoals) {</span>
<span class="fc" id="L955">                array.put(goalToJSON(subgoal));</span>
<span class="fc" id="L956">            }</span>
<span class="fc" id="L957">            jsonObject.put(&quot;subgoals&quot;, array);</span>
        }

<span class="fc" id="L960">        return jsonObject;</span>
    }

    /**
     * Gets the loaded game
     * 
     * @return DungeonMania
     */
    public DungeonMania getLoadedGame() {
<span class="fc" id="L969">        return this.loadedgame;</span>
    }
    public void RewindGame() throws IllegalArgumentException {
<span class="fc" id="L972">        int numSaves = tick;</span>
<span class="fc" id="L973">        String difficulty = this.loadedgame.getDifficulty();</span>
<span class="fc" id="L974">        String mapName = this.loadedgame.getName();</span>
<span class="fc" id="L975">        JSONObject jsonObject = new JSONObject();</span>

<span class="fc" id="L977">        jsonObject.put(&quot;difficulty&quot;, difficulty);</span>
<span class="fc" id="L978">        jsonObject.put(&quot;mapName&quot;, mapName);</span>

<span class="fc" id="L980">        JSONArray entities = new JSONArray();</span>
<span class="fc" id="L981">        List&lt;Entity&gt; gameEntities = this.loadedgame.getEntities();</span>

<span class="fc bfc" id="L983" title="All 2 branches covered.">        for (Entity entity : gameEntities) {</span>
<span class="fc" id="L984">            JSONObject newEntity = new JSONObject();</span>
<span class="fc" id="L985">            int xPos = entity.getPos().getX();</span>
<span class="fc" id="L986">            int yPos = entity.getPos().getY();</span>
<span class="fc" id="L987">            String type = entity.getType();</span>
<span class="fc" id="L988">            newEntity.put(&quot;x&quot;, xPos);</span>
<span class="fc" id="L989">            newEntity.put(&quot;y&quot;, yPos);</span>
<span class="fc bfc" id="L990" title="All 2 branches covered.">            if(type.equals(&quot;player&quot;)) {</span>
<span class="fc" id="L991">                newEntity.put(&quot;type&quot;, &quot;older_player&quot;);    </span>
            }
            else {
<span class="fc" id="L994">            newEntity.put(&quot;type&quot;, type);</span>
            }
<span class="fc" id="L996">            entities.put(newEntity);</span>
<span class="fc" id="L997">        }</span>

<span class="fc" id="L999">        JSONArray inventory = new JSONArray();</span>
<span class="fc" id="L1000">        List&lt;Entity&gt; gameItems = this.loadedgame.getItems();</span>

<span class="fc bfc" id="L1002" title="All 2 branches covered.">        for (Entity item : gameItems) {</span>
<span class="fc" id="L1003">            JSONObject newEntity = new JSONObject();</span>
<span class="fc" id="L1004">            String type = item.getType();</span>
<span class="fc" id="L1005">            newEntity.put(&quot;type&quot;, type);</span>
<span class="fc" id="L1006">            inventory.put(newEntity);</span>
<span class="fc" id="L1007">        }</span>

<span class="fc" id="L1009">        jsonObject.put(&quot;entities&quot;, entities);</span>
<span class="fc" id="L1010">        jsonObject.put(&quot;inventory&quot;, inventory);</span>

<span class="fc" id="L1012">        Goal gameGoals = this.loadedgame.getGoal();</span>
<span class="fc" id="L1013">        JSONObject goals = goalToJSON(gameGoals);</span>
<span class="fc" id="L1014">        jsonObject.put(&quot;goal-condition&quot;, goals);</span>

<span class="fc" id="L1016">        String conts = jsonObject.toString();</span>

        try {
<span class="fc" id="L1019">            String pathname = &quot;src/main/resources/rewindsaves/&quot;;</span>
<span class="fc" id="L1020">            String filename = difficulty + &quot;-&quot; + mapName + &quot;-&quot; + Integer.toString(numSaves) + &quot;-&quot; + &quot;.json&quot;;</span>
<span class="fc" id="L1021">            File f = new File(pathname);</span>
<span class="fc" id="L1022">            f.mkdir();</span>
<span class="fc" id="L1023">            String absolutePathName = f.getAbsolutePath();</span>
<span class="fc" id="L1024">            File save = new File(absolutePathName + &quot;/&quot; + filename);</span>
<span class="fc" id="L1025">            save.createNewFile();</span>
<span class="fc" id="L1026">            writeToFile(conts, absolutePathName + &quot;/&quot; + filename);</span>
<span class="nc" id="L1027">        } catch (IOException e) {</span>

<span class="fc" id="L1029">        }</span>

<span class="fc" id="L1031">        String goalString = GoalFactory.goalString(this.loadedgame.getGoal());</span>
<span class="fc" id="L1032">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>