<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DungeonManiaController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">project</a> &gt; <a href="index.source.html" class="el_package">dungeonmania</a> &gt; <span class="el_source">DungeonManiaController.java</span></div><h1>DungeonManiaController.java</h1><pre class="source lang-java linenums">package dungeonmania;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.ThreadLocalRandom;

import org.json.JSONArray;
import org.json.JSONObject;
import org.json.JSONTokener;

import dungeonmania.exceptions.InvalidActionException;
import dungeonmania.response.models.DungeonResponse;
import dungeonmania.response.models.EntityResponse;
import dungeonmania.response.models.ItemResponse;
import dungeonmania.util.Direction;
import dungeonmania.util.FileLoader;
import dungeonmania.util.Position;
import dungeonmania.util.Prims;
import dungeonmania.Battles.BattleOutcome;

public class DungeonManiaController {
    private ArrayList&lt;DungeonMania&gt; games;
    private DungeonMania loadedgame;
    private int tick;

<span class="fc" id="L31">    public DungeonManiaController() {</span>
<span class="fc" id="L32">        this.games = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L33">        this.tick = 0;</span>
<span class="fc" id="L34">    }</span>

    /**
     * Gets list of existing games
     * 
     * @return ArrayList&lt;DungeonMania&gt;
     */
    public ArrayList&lt;DungeonMania&gt; getGames() {
<span class="fc" id="L42">        return games;</span>
    }

    /**
     * Sets the list of existing games
     * 
     * @param games
     */
    public void setGames(ArrayList&lt;DungeonMania&gt; games) {
<span class="nc" id="L51">        this.games = games;</span>
<span class="nc" id="L52">    }</span>

    /**
     * Gets current skin
     * 
     * @return String
     */
    public String getSkin() {
<span class="nc" id="L60">        return &quot;default&quot;;</span>
    }

    /**
     * Gets localisation
     * 
     * @return String
     */
    public String getLocalisation() {
<span class="nc" id="L69">        return &quot;en_US&quot;;</span>
    }

    /**
     * Gets list of gamemodes
     * 
     * @return List&lt;String&gt;
     */
    public List&lt;String&gt; getGameModes() {
<span class="nc" id="L78">        return Arrays.asList(&quot;Standard&quot;, &quot;Peaceful&quot;, &quot;Hard&quot;);</span>
    }

    /**
     * /dungeons
     * 
     * Done for you.
     */
    public static List&lt;String&gt; dungeons() {
        try {
<span class="fc" id="L88">            return FileLoader.listFileNamesInResourceDirectory(&quot;/dungeons&quot;);</span>
<span class="nc" id="L89">        } catch (IOException e) {</span>
<span class="nc" id="L90">            return new ArrayList&lt;&gt;();</span>
        }
    }

    /**
     * Initializes game state + spawns in all entities and main character + items
     * 
     * @param dungeonName
     * @param gameMode
     * @return DungeonResponse
     * @throws IllegalArgumentException
     */
    public DungeonResponse newGame(String dungeonName, String gameMode) throws IllegalArgumentException {
<span class="fc" id="L103">        Boolean peaceful = gameMode.equalsIgnoreCase(&quot;peaceful&quot;);</span>
<span class="fc" id="L104">        Boolean standard = gameMode.equalsIgnoreCase(&quot;standard&quot;);</span>
<span class="fc" id="L105">        Boolean hard = gameMode.equalsIgnoreCase(&quot;hard&quot;);</span>
<span class="fc bfc" id="L106" title="All 6 branches covered.">        if (!peaceful &amp;&amp; !standard &amp;&amp; !hard) {</span>
<span class="fc" id="L107">            throw new IllegalArgumentException(&quot;invalid gamemode&quot;);</span>
        }
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (!dungeons().contains(dungeonName)) {</span>
<span class="fc" id="L110">            throw new IllegalArgumentException(&quot;invalid dungeonName&quot;);</span>
        }
<span class="fc" id="L112">        List&lt;ItemResponse&gt; items = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L113">        List&lt;String&gt; buildables = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L114">        DungeonMania dungeonMania = new DungeonMania(gameMode, dungeonName);</span>
<span class="fc" id="L115">        JSONObject dungeon = null;</span>
<span class="fc" id="L116">        File f = new File(&quot;src/main/resources/dungeons/&quot; + dungeonName + &quot;.json&quot;);</span>
<span class="fc" id="L117">        String s = f.getAbsolutePath();</span>

        try {
<span class="fc" id="L120">            dungeon = new JSONObject(new JSONTokener(new FileReader(s)));</span>
<span class="nc" id="L121">        } catch (Exception e) {</span>
<span class="fc" id="L122">        }</span>
<span class="fc" id="L123">        JSONArray entities = dungeon.getJSONArray(&quot;entities&quot;);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">        for (int i = 0; i &lt; entities.length(); i++) {</span>
<span class="fc" id="L125">            String type = entities.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="fc" id="L126">            int x = entities.getJSONObject(i).getInt(&quot;x&quot;);</span>
<span class="fc" id="L127">            int y = entities.getJSONObject(i).getInt(&quot;y&quot;);</span>
<span class="fc" id="L128">            Position pos = new Position(x, y, 0); // placeholder for layer</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">            if (type.equalsIgnoreCase(&quot;portal&quot;)) {</span>
<span class="fc" id="L130">                dungeonMania.createPortal(pos, type, entities.getJSONObject(i).getString(&quot;colour&quot;));</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            } else if (type.equalsIgnoreCase(&quot;swamp_tile&quot;)) {</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">                if (entities.getJSONObject(i).has(&quot;movement_factor&quot;)) {</span>
<span class="fc" id="L133">                    int movement_factor = entities.getJSONObject(i).getInt(&quot;movement_factor&quot;);</span>
<span class="fc" id="L134">                    dungeonMania.addSwampTile(new SwampTile(new Position(x, y), movement_factor));</span>
<span class="fc" id="L135">                } else {</span>
<span class="nc" id="L136">                    dungeonMania.addSwampTile(new SwampTile(new Position(x, y)));</span>
                }
            } else {
<span class="fc" id="L139">                dungeonMania.createEntity(pos, type);</span>
            }
        }
<span class="fc bfc" id="L142" title="All 2 branches covered.">        for (int i = 0; i &lt; ThreadLocalRandom.current().nextInt(0,5); i++) {</span>
<span class="fc" id="L143">            dungeonMania.spawnSpider();</span>
        }
<span class="fc" id="L145">        JSONObject jsonGoalCondition = dungeon.getJSONObject(&quot;goal-condition&quot;);</span>
<span class="fc" id="L146">        dungeonMania.setGoal(GoalFactory.generate(jsonGoalCondition.toString()));</span>
<span class="fc" id="L147">        List&lt;EntityResponse&gt; entityResponses = dungeonMania.getEntityResponses();</span>
<span class="fc" id="L148">        dungeonMania.setId(Integer.toString(this.games.size() + 1));</span>
<span class="fc" id="L149">        this.games.add(dungeonMania);</span>
<span class="fc" id="L150">        this.loadedgame = dungeonMania;</span>
<span class="fc" id="L151">        return new DungeonResponse(dungeonMania.getId(), dungeonName, entityResponses, items, buildables,</span>
<span class="fc" id="L152">                GoalFactory.goalString(dungeonMania.getGoal()));</span>
    }

    /**
     * Saves a game given the name of the game instance
     * 
     * @param name
     * @return DungeonResponse
     * @throws IllegalArgumentException
     */
    public DungeonResponse saveGame(String name) throws IllegalArgumentException {
<span class="fc" id="L163">        int numSaves = allGames().size();</span>
<span class="fc" id="L164">        String difficulty = this.loadedgame.getDifficulty();</span>
<span class="fc" id="L165">        String mapName = this.loadedgame.getName();</span>
<span class="fc" id="L166">        JSONObject jsonObject = new JSONObject();</span>

<span class="fc" id="L168">        jsonObject.put(&quot;difficulty&quot;, difficulty);</span>
<span class="fc" id="L169">        jsonObject.put(&quot;mapName&quot;, mapName);</span>

<span class="fc" id="L171">        JSONArray entities = new JSONArray();</span>
<span class="fc" id="L172">        List&lt;Entity&gt; gameEntities = this.loadedgame.getEntities();</span>

<span class="fc bfc" id="L174" title="All 2 branches covered.">        for (Entity entity : gameEntities) {</span>
<span class="fc" id="L175">            JSONObject newEntity = new JSONObject();</span>
<span class="fc" id="L176">            int xPos = entity.getPos().getX();</span>
<span class="fc" id="L177">            int yPos = entity.getPos().getY();</span>
<span class="fc" id="L178">            String type = entity.getType();</span>
<span class="fc" id="L179">            newEntity.put(&quot;x&quot;, xPos);</span>
<span class="fc" id="L180">            newEntity.put(&quot;y&quot;, yPos);</span>
<span class="fc" id="L181">            newEntity.put(&quot;type&quot;, type);</span>
<span class="fc" id="L182">            entities.put(newEntity);</span>
<span class="fc" id="L183">        }</span>

<span class="fc" id="L185">        JSONArray inventory = new JSONArray();</span>
<span class="fc" id="L186">        List&lt;Entity&gt; gameItems = this.loadedgame.getItems();</span>

<span class="fc bfc" id="L188" title="All 2 branches covered.">        for (Entity item : gameItems) {</span>
<span class="fc" id="L189">            JSONObject newEntity = new JSONObject();</span>
<span class="fc" id="L190">            String type = item.getType();</span>
<span class="fc" id="L191">            newEntity.put(&quot;type&quot;, type);</span>
<span class="fc" id="L192">            inventory.put(newEntity);</span>
<span class="fc" id="L193">        }</span>

<span class="fc" id="L195">        jsonObject.put(&quot;entities&quot;, entities);</span>
<span class="fc" id="L196">        jsonObject.put(&quot;inventory&quot;, inventory);</span>

<span class="fc" id="L198">        Goal gameGoals = this.loadedgame.getGoal();</span>
<span class="fc" id="L199">        JSONObject goals = goalToJSON(gameGoals);</span>
<span class="fc" id="L200">        jsonObject.put(&quot;goal-condition&quot;, goals);</span>

<span class="fc" id="L202">        String conts = jsonObject.toString();</span>

        try {
<span class="fc" id="L205">            String pathname = &quot;src/main/resources/saves/&quot;;</span>
<span class="fc" id="L206">            String filename = difficulty + &quot;-&quot; + mapName + &quot;-&quot; + Integer.toString(numSaves) + &quot;-&quot; + &quot;.json&quot;;</span>
<span class="fc" id="L207">            File f = new File(pathname);</span>
<span class="fc" id="L208">            String absolutePathName = f.getAbsolutePath();</span>
<span class="fc" id="L209">            File save = new File(absolutePathName + filename);</span>
<span class="fc" id="L210">            save.createNewFile();</span>
<span class="fc" id="L211">            writeToFile(conts, absolutePathName + &quot;/&quot; + filename);</span>
<span class="nc" id="L212">        } catch (IOException e) {</span>

<span class="fc" id="L214">        }</span>

<span class="fc" id="L216">        String id = this.loadedgame.getId();</span>
<span class="fc" id="L217">        String gameName = this.loadedgame.getName();</span>
<span class="fc" id="L218">        List&lt;EntityResponse&gt; entityResponses = this.loadedgame.getEntityResponses();</span>
<span class="fc" id="L219">        List&lt;ItemResponse&gt; itemResponses = this.loadedgame.getItemResponses();</span>
<span class="fc" id="L220">        String goalString = GoalFactory.goalString(this.loadedgame.getGoal());</span>
<span class="fc" id="L221">        this.loadedgame = null;</span>

<span class="fc" id="L223">        return new DungeonResponse(id, gameName, entityResponses, itemResponses, null, goalString);</span>
    }

    /**
     * Loads a specific game given the name of the game
     * 
     * @param name
     * @return DungeonResponse
     * @throws IllegalArgumentException
     */
    public DungeonResponse loadGame(String name) throws IllegalArgumentException {
        try {
<span class="fc" id="L235">            List&lt;String&gt; saves = allGames();</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">            if (!saves.contains(name)) {</span>
<span class="nc" id="L237">                throw new IllegalArgumentException();</span>
            }
<span class="nc" id="L239">        } catch (IllegalArgumentException e) {</span>

<span class="fc" id="L241">        }</span>

<span class="fc" id="L243">        List&lt;ItemResponse&gt; items = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L244">        List&lt;String&gt; buildables = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L246">        File f = new File(&quot;src/main/resources/saves/&quot; + name);</span>
<span class="fc" id="L247">        String s = f.getAbsolutePath();</span>
<span class="fc" id="L248">        JSONObject dungeon = null;</span>

        try {
<span class="fc" id="L251">            dungeon = new JSONObject(new JSONTokener(new FileReader(s)));</span>
<span class="nc" id="L252">        } catch (Exception e) {</span>
<span class="fc" id="L253">        }</span>

<span class="fc" id="L255">        String difficulty = dungeon.getString(&quot;difficulty&quot;);</span>
<span class="fc" id="L256">        String mapName = dungeon.getString(&quot;mapName&quot;);</span>
<span class="fc" id="L257">        DungeonMania dungeonMania = new DungeonMania(difficulty, mapName);</span>

<span class="fc" id="L259">        JSONArray entities = dungeon.getJSONArray(&quot;entities&quot;);</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        for (int i = 0; i &lt; entities.length(); i++) {</span>
<span class="fc" id="L261">            String type = entities.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="fc" id="L262">            int x = entities.getJSONObject(i).getInt(&quot;x&quot;);</span>
<span class="fc" id="L263">            int y = entities.getJSONObject(i).getInt(&quot;y&quot;);</span>
<span class="fc" id="L264">            Position pos = new Position(x, y, 0); // placeholder for layer</span>
<span class="fc" id="L265">            dungeonMania.createEntity(pos, type);</span>
        }

<span class="fc" id="L268">        JSONArray inventory = dungeon.getJSONArray(&quot;inventory&quot;);</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">        for (int i = 0; i &lt; inventory.length(); i++) {</span>
<span class="fc" id="L270">            String type = inventory.getJSONObject(i).getString(&quot;type&quot;);</span>
<span class="fc" id="L271">            dungeonMania.AddItem(type);</span>
        }

<span class="fc" id="L274">        JSONObject jsonGoalCondition = dungeon.getJSONObject(&quot;goal-condition&quot;);</span>
<span class="fc" id="L275">        dungeonMania.setGoal(GoalFactory.generate(jsonGoalCondition.toString()));</span>
<span class="fc" id="L276">        List&lt;EntityResponse&gt; entityResponses = dungeonMania.getEntityResponses();</span>
<span class="fc" id="L277">        dungeonMania.setId(Integer.toString(this.games.size() + 1));</span>
<span class="fc" id="L278">        this.games.add(dungeonMania);</span>
<span class="fc" id="L279">        this.loadedgame = dungeonMania;</span>
<span class="fc" id="L280">        return new DungeonResponse(dungeonMania.getId(), mapName, entityResponses, items, buildables,</span>
<span class="fc" id="L281">                GoalFactory.goalString(dungeonMania.getGoal()));</span>

    }

    /**
     * Checks if a position is adjacent
     * 
     * @param e
     * @return boolean
     */
    public boolean RealisAdjacent(Position e) {
<span class="fc" id="L292">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc" id="L293">        List&lt;Direction&gt; directions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L294">        directions.add(Direction.UP);</span>
<span class="fc" id="L295">        directions.add(Direction.DOWN);</span>
<span class="fc" id="L296">        directions.add(Direction.LEFT);</span>
<span class="fc" id="L297">        directions.add(Direction.RIGHT);</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">        for (Direction d : directions) {</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">            if (dungeon.getCharacter().getPos().translateBy(d).equals(e)) {</span>
<span class="fc" id="L300">                return true;</span>
            }
<span class="fc" id="L302">        }</span>
<span class="fc" id="L303">        return false;</span>
    }

    public boolean RealisBomb(Position e) {
<span class="fc" id="L307">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc" id="L308">        List&lt;Direction&gt; directions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L309">        directions.add(Direction.UP);</span>
<span class="fc" id="L310">        directions.add(Direction.DOWN);</span>
<span class="fc" id="L311">        directions.add(Direction.LEFT);</span>
<span class="fc" id="L312">        directions.add(Direction.RIGHT);</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">        for (Direction d : directions) {</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">            if (dungeon.getCharacter().getPos().translateBy(d).equals(e)) {</span>
<span class="fc" id="L315">                return true;</span>
            }
<span class="fc" id="L317">        }</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">        if (dungeon.getCharacter().getPos().translateBy(Direction.UP).translateBy(Direction.LEFT).equals(e)) {</span>
<span class="nc" id="L319">            return true;</span>
        }
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        if (dungeon.getCharacter().getPos().translateBy(Direction.UP).translateBy(Direction.RIGHT).equals(e)) {</span>
<span class="nc" id="L322">            return true;</span>
        }
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">        if (dungeon.getCharacter().getPos().translateBy(Direction.DOWN).translateBy(Direction.LEFT).equals(e)) {</span>
<span class="nc" id="L325">            return true;</span>
        }
<span class="fc bfc" id="L327" title="All 2 branches covered.">        if (dungeon.getCharacter().getPos().translateBy(Direction.DOWN).translateBy(Direction.RIGHT).equals(e)) {</span>
<span class="fc" id="L328">            return true;</span>
        }
<span class="fc" id="L330">        return false;</span>
    }

    /**
     * Checks if a mercenary is adjacent to a given position
     * 
     * @param e
     * @return boolean
     */
    public boolean isMercenaryAdjacent(Position e) {
<span class="fc" id="L340">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc" id="L341">        List&lt;Direction&gt; directions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L342">        directions.add(Direction.UP);</span>
<span class="fc" id="L343">        directions.add(Direction.DOWN);</span>
<span class="fc" id="L344">        directions.add(Direction.LEFT);</span>
<span class="fc" id="L345">        directions.add(Direction.RIGHT);</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">        for (Direction d : directions) {</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">            if (dungeon.getCharacter().getPos().translateBy(d).translateBy(d).equals(e)) {</span>
<span class="nc" id="L348">                return true;</span>
            }
<span class="fc" id="L350">        }</span>
<span class="fc" id="L351">        return false;</span>
    }

    /**
     * Returns a list of all the games (saved and current)
     * 
     * @return List&lt;String&gt;
     */
    public List&lt;String&gt; allGames() {
<span class="fc" id="L360">        File f = new File(&quot;src/main/resources/&quot;);</span>
<span class="fc" id="L361">        String filepath = f.getAbsolutePath();</span>
<span class="fc" id="L362">        List&lt;String&gt; saves = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L363">        File savespath = new File(filepath + &quot;/saves/&quot;);</span>
<span class="fc" id="L364">        saves = Arrays.asList(savespath.list());</span>
<span class="fc" id="L365">        return saves;</span>
    }

    /**
     * Advances the game state by one tick also calculates what craftables the
     * character may have access to uses items if items have been used and moves the
     * character given the direction does battle, and checks if the game has ended
     * through the goal condition/ player death. and updates the state of all
     * entities in the game.
     * 
     * @param itemUsed
     * @param movementDirection
     * @return
     * @throws IllegalArgumentException
     * @throws InvalidActionException
     */
    public DungeonResponse tick(String itemUsed, Direction movementDirection)
            throws IllegalArgumentException, InvalidActionException {
        String Goalstring;
<span class="fc" id="L384">        DungeonMania currentGame = this.loadedgame;</span>
<span class="fc" id="L385">        List&lt;String&gt; buildables = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L386">        Character updateCharacter = currentGame.getCharacter();</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">        if (!updateCharacter.getInBattle()) {</span>
<span class="fc" id="L388">            updateCharacter.move(currentGame, movementDirection);</span>
<span class="fc" id="L389">            currentGame.setCharacter(updateCharacter);</span>
<span class="fc" id="L390">            currentGame.updateEntities(updateCharacter);</span>
        }
<span class="fc" id="L392">        CheckBow();</span>
<span class="fc" id="L393">        CheckShield();</span>
<span class="fc" id="L394">        Goal goal = currentGame.getGoal();</span>
<span class="fc" id="L395">        List&lt;Entity&gt; toRemove = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L396">        updateCharacter.updateChar();</span>
<span class="fc bfc" id="L397" title="All 4 branches covered.">        if (tick % 30 == 0 &amp;&amp; tick != 0) {</span>
<span class="fc" id="L398">            currentGame.spawnMercenary();</span>
        }
<span class="fc bfc" id="L400" title="All 6 branches covered.">        if (tick % 50 == 0 &amp;&amp; tick != 0 &amp;&amp; currentGame.getDifficulty().equalsIgnoreCase(&quot;hard&quot;)) {</span>
<span class="fc" id="L401">            currentGame.spawnHydra();</span>
        }
<span class="fc bfc" id="L403" title="All 2 branches covered.">        if (itemUsed != null) {</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">            if (currentGame.getItemFromId(itemUsed) == null) {</span>
<span class="nc" id="L405">                throw new InvalidActionException(&quot;Item Not In Inventory&quot;);</span>
            }
<span class="fc bfc" id="L407" title="All 2 branches covered.">            if (currentGame.getItemFromId(itemUsed).getType().equals(&quot;bomb&quot;)) {</span>
<span class="fc" id="L408">                Boolean isActivated = false;</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">                for (Entity entity : currentGame.getEntities()) {</span>
<span class="fc bfc" id="L410" title="All 4 branches covered.">                    if (entity.getType().equals(&quot;switch&quot;) &amp;&amp; RealisAdjacent(entity.getPos())) {</span>
<span class="fc" id="L411">                        isActivated = ((FloorSwitch) entity).isTriggered();</span>
                    }
<span class="fc" id="L413">                }</span>
<span class="fc bfc" id="L414" title="All 2 branches covered.">                if (!isActivated) {</span>
<span class="fc" id="L415">                    throw new InvalidActionException(&quot;not activated&quot;);</span>
                }
<span class="fc" id="L417">                List&lt;Entity&gt; removable = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L418" title="All 2 branches covered.">                for (Entity entity : currentGame.getEntities()) {</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">                    if (RealisBomb(entity.getPos())) {</span>
<span class="fc" id="L420">                        removable.add(entity);</span>
                    }
<span class="fc" id="L422">                }</span>
<span class="fc bfc" id="L423" title="All 2 branches covered.">                for (Entity e : removable) {</span>
<span class="fc" id="L424">                    currentGame.removeEntity(e);</span>
<span class="fc" id="L425">                }</span>
<span class="fc" id="L426">                currentGame.removeItem(currentGame.getItemFromId(itemUsed));</span>
<span class="fc" id="L427">                return new DungeonResponse(currentGame.getId(), currentGame.getName(), currentGame.getEntityResponses(),</span>
<span class="fc" id="L428">                        currentGame.getItemResponses(), buildables, GoalFactory.goalString(currentGame.getGoal()));</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">            } else if (currentGame.getItemFromId(itemUsed).getType().equals(&quot;health_potion&quot;)) {</span>
<span class="fc" id="L430">                updateCharacter.setHealth(30);</span>
<span class="fc" id="L431">                currentGame.removeItem(currentGame.getItemFromId(itemUsed));</span>
<span class="fc" id="L432">                return new DungeonResponse(currentGame.getId(), currentGame.getName(), currentGame.getEntityResponses(),</span>
<span class="fc" id="L433">                        currentGame.getItemResponses(), buildables, GoalFactory.goalString(currentGame.getGoal()));</span>
<span class="fc bfc" id="L434" title="All 2 branches covered.">            } else if (currentGame.getItemFromId(itemUsed).getType().equals(&quot;invisibility_potion&quot;)) {</span>
<span class="fc" id="L435">                updateCharacter.setInvisibleTimer(5);</span>
<span class="fc" id="L436">                updateCharacter.setInvisible(true);</span>
<span class="fc" id="L437">                currentGame.removeItem(currentGame.getItemFromId(itemUsed));</span>
<span class="fc" id="L438">                return new DungeonResponse(currentGame.getId(), currentGame.getName(), currentGame.getEntityResponses(),</span>
<span class="fc" id="L439">                        currentGame.getItemResponses(), buildables, GoalFactory.goalString(currentGame.getGoal()));</span>
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">            } else if (currentGame.getItemFromId(itemUsed).getType().equals(&quot;invincibility_potion&quot;)) {</span>
<span class="fc" id="L441">                updateCharacter.setInvincibleTimer(5);</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">                if (!currentGame.getDifficulty().equalsIgnoreCase(&quot;Hard&quot;)) {</span>
<span class="fc" id="L443">                    updateCharacter.setInvincible(true);</span>
                }
<span class="fc" id="L445">                currentGame.removeItem(currentGame.getItemFromId(itemUsed));</span>
<span class="fc" id="L446">                return new DungeonResponse(currentGame.getId(), currentGame.getName(), currentGame.getEntityResponses(),</span>
<span class="fc" id="L447">                        currentGame.getItemResponses(), buildables, GoalFactory.goalString(currentGame.getGoal()));</span>
            } else {
<span class="nc" id="L449">                throw new IllegalArgumentException(&quot;invalid item id&quot;);</span>
            }
        }
<span class="fc" id="L452">        List&lt;Entity&gt; zombieToastSpawners = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L453" title="All 2 branches covered.">        for (Entity entity : currentGame.getEntities()) {</span>
<span class="fc bfc" id="L454" title="All 2 branches covered.">            if (entity instanceof MovingEntity) {</span>
<span class="fc bfc" id="L455" title="All 2 branches covered.">                if (entity instanceof Mercenary) {</span>
<span class="fc" id="L456">                    int ticksLeftOnBribe = ((Mercenary) entity).getTicksLeftOnBribe();</span>
<span class="fc bfc" id="L457" title="All 2 branches covered.">                    if (ticksLeftOnBribe &gt; 1) {</span>
<span class="fc" id="L458">                        ((Mercenary) entity).setTicksLeftOnBribe(ticksLeftOnBribe - 1);</span>
<span class="fc bfc" id="L459" title="All 2 branches covered.">                    } else if (ticksLeftOnBribe == 1) {</span>
<span class="fc" id="L460">                        ((Mercenary) entity).setTicksLeftOnBribe(ticksLeftOnBribe - 1);</span>
<span class="fc" id="L461">                        updateCharacter.removeAlly((MovingEntity) entity);</span>
<span class="fc" id="L462">                        ((Mercenary) entity).setIsBribed(false);</span>
                    }
                }
<span class="fc bfc" id="L465" title="All 4 branches covered.">                if (updateCharacter.getInBattle() &amp;&amp; !((MovingEntity) entity).getInBattle()) {</span>
<span class="fc" id="L466">                    ((MovingEntity) entity).move(currentGame);</span>
                }
<span class="fc bfc" id="L468" title="All 4 branches covered.">                if (updateCharacter.getInBattle() &amp;&amp; entity instanceof Mercenary</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">                        &amp;&amp; !((MovingEntity) entity).getInBattle()) {</span>
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">                    if (isMercenaryAdjacent(entity.getPos())) {</span>
<span class="nc" id="L471">                        ((MovingEntity) entity).move(currentGame);</span>
                    }
                }

<span class="pc bpc" id="L475" title="1 of 4 branches missed.">                if (!updateCharacter.getInBattle() &amp;&amp; !((MovingEntity) entity).getInBattle()) {</span>
<span class="fc" id="L476">                    ((MovingEntity) entity).move(currentGame);</span>
<span class="fc bfc" id="L477" title="All 4 branches covered.">                    if (((MovingEntity) entity).isHostile() &amp;&amp; updateCharacter.getPos().equals(entity.getPos())</span>
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">                            &amp;&amp; !currentGame.getDifficulty().equalsIgnoreCase(&quot;peaceful&quot;)) {</span>
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">                        if (!loadedgame.getCharacter().getisInvisible()) {</span>
<span class="fc" id="L480">                            updateCharacter.setInBattle(true);</span>
<span class="fc" id="L481">                            ((MovingEntity) entity).setInBattle(true);</span>
                        }
                    }
                }
<span class="fc bfc" id="L485" title="All 4 branches covered.">                if (updateCharacter.getInBattle() &amp;&amp; ((MovingEntity) entity).getInBattle()</span>
<span class="fc bfc" id="L486" title="All 2 branches covered.">                        &amp;&amp; ((MovingEntity) entity).isHostile()) {</span>
<span class="fc" id="L487">                    BattleOutcome outcome = Battles.Battle(updateCharacter, (MovingEntity) entity,</span>
<span class="fc" id="L488">                            currentGame.getItems());</span>
<span class="fc bfc" id="L489" title="All 2 branches covered.">                    if (outcome == BattleOutcome.CHARACTER_WINS) {</span>
<span class="fc" id="L490">                        toRemove.add(entity);</span>
<span class="pc bpc" id="L491" title="1 of 4 branches missed.">                        if (entity instanceof ZombieToast &amp;&amp; ((ZombieToast) entity).HasArmour()) {</span>
<span class="nc" id="L492">                            currentGame.winItem(((ZombieToast) entity).getArmour());</span>
                        }
<span class="fc bfc" id="L494" title="All 4 branches covered.">                        if (entity instanceof Mercenary &amp;&amp; ((Mercenary) entity).HasArmour()) {</span>
<span class="fc" id="L495">                            currentGame.winItem(((Mercenary) entity).getArmour());</span>
                        }
<span class="fc" id="L497">                        int probability = ThreadLocalRandom.current().nextInt(0, 11);</span>
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">                        if (probability == 1) {</span>
<span class="nc" id="L499">                            currentGame.AddItem(&quot;one_ring&quot;);</span>
                        }

<span class="fc bfc" id="L502" title="All 2 branches covered.">                    } else if (outcome == BattleOutcome.ENEMY_WINS) {</span>
<span class="fc" id="L503">                        Boolean HasOneRing = false;</span>
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">                        for (Entity item : currentGame.getItems()) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                            if (item instanceof TheOneRingEntity) {</span>
<span class="nc" id="L506">                                HasOneRing = true;</span>
<span class="nc" id="L507">                                ((TheOneRingEntity) item).setIsUsed(true);</span>
                            }
<span class="nc" id="L509">                        }</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">                        if (!HasOneRing) {</span>
<span class="fc" id="L511">                            toRemove.add(updateCharacter);</span>
                        } else {
<span class="nc" id="L513">                            Character newLife = currentGame.getCharacter();</span>
<span class="nc" id="L514">                            newLife.setHealth(30);</span>
<span class="nc" id="L515">                            currentGame.setCharacter(newLife);</span>
                        }

                    }
<span class="fc" id="L519">                    currentGame.removeUsedItems();</span>
                }
            }

<span class="fc bfc" id="L523" title="All 2 branches covered.">            if (entity instanceof CollectableEntities) {</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">                if (updateCharacter.getPos().equals(entity.getPos())) {</span>
<span class="fc" id="L525">                    toRemove.add(entity);</span>
<span class="fc" id="L526">                    currentGame.AddItem(entity.getType());</span>
                }
            }
<span class="fc bfc" id="L529" title="All 2 branches covered.">            if (entity instanceof StaticEntity) {</span>
<span class="fc bfc" id="L530" title="All 2 branches covered.">                if (entity instanceof FloorSwitch) {</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">                    if (((FloorSwitch) entity).checkTriggered(currentGame.getEntities())) {</span>
<span class="fc" id="L532">                        ((FloorSwitch) entity).setisTriggered(true);</span>
                    }
                }
<span class="fc bfc" id="L535" title="All 2 branches covered.">                if (entity instanceof ZombieToastSpawner) {</span>
<span class="fc" id="L536">                    ((ZombieToastSpawner) entity)</span>
<span class="fc" id="L537">                            .setTicksSinceSpawn(((ZombieToastSpawner) entity).getTicksSinceSpawn() + 1);</span>
<span class="fc bfc" id="L538" title="All 2 branches covered.">                    Boolean Standardspawn = ((ZombieToastSpawner) entity).getTicksSinceSpawn() % 20 == 0;</span>
<span class="fc" id="L539">                    Boolean IsOnHard = currentGame.getDifficulty().equalsIgnoreCase(&quot;hard&quot;);</span>
<span class="fc bfc" id="L540" title="All 2 branches covered.">                    Boolean HardSpawn = ((ZombieToastSpawner) entity).getTicksSinceSpawn() % 15 == 0;</span>
<span class="pc bpc" id="L541" title="2 of 8 branches missed.">                    if ((Standardspawn &amp;&amp; !IsOnHard) || (HardSpawn &amp;&amp; IsOnHard)) {</span>
<span class="fc" id="L542">                        zombieToastSpawners.add(entity);</span>
<span class="fc" id="L543">                        ((ZombieToastSpawner) entity).setTicksSinceSpawn(0);</span>
                    }
                }
            }
<span class="fc" id="L547">        }</span>
<span class="fc bfc" id="L548" title="All 2 branches covered.">        if (zombieToastSpawners.size() &gt; 0) {</span>
<span class="fc bfc" id="L549" title="All 2 branches covered.">            for (Entity zombie : zombieToastSpawners) {</span>
<span class="fc" id="L550">                currentGame.spawnZombie(((ZombieToastSpawner) zombie).getPos());</span>
<span class="fc" id="L551">            }</span>
        }

<span class="fc bfc" id="L554" title="All 2 branches covered.">        for (Entity entity : toRemove) {</span>
<span class="fc" id="L555">            currentGame.removeEntity(entity);</span>
<span class="fc" id="L556">        }</span>

<span class="fc" id="L558">        String id = currentGame.getId();</span>
<span class="fc" id="L559">        String name = currentGame.getName();</span>
<span class="fc" id="L560">        List&lt;EntityResponse&gt; e = currentGame.getEntityResponses();</span>
<span class="fc" id="L561">        List&lt;ItemResponse&gt; i = currentGame.getItemResponses();</span>
<span class="fc bfc" id="L562" title="All 2 branches covered.">        if (goal.isComplete(currentGame)) {</span>
<span class="fc" id="L563">            Goalstring = &quot;&quot;;</span>
<span class="fc" id="L564">            this.loadedgame = null;</span>
        } else {
<span class="fc" id="L566">            Goalstring = GoalFactory.goalString(currentGame.getGoal());</span>
        }
<span class="fc" id="L568">        tick++;</span>
<span class="fc" id="L569">        return new DungeonResponse(id, name, e, i, currentGame.getBuildables(), Goalstring);</span>

    }

    /**
     * Interacts with a given entity Id
     * 
     * @param entityId
     * @return DungeonResponse
     * @throws IllegalArgumentException
     * @throws InvalidActionException
     */
    public DungeonResponse interact(String entityId) throws IllegalArgumentException, InvalidActionException {
<span class="fc" id="L582">        DungeonMania loadedgame = this.loadedgame;</span>
<span class="fc" id="L583">        Entity interactableEntity = null;</span>
<span class="fc bfc" id="L584" title="All 2 branches covered.">        for (Entity entity : loadedgame.getEntities()) {</span>
<span class="fc bfc" id="L585" title="All 2 branches covered.">            if (entity.getId().equals(entityId)) {</span>
<span class="fc" id="L586">                interactableEntity = entity;</span>
            }
<span class="fc" id="L588">        }</span>
<span class="fc bfc" id="L589" title="All 4 branches covered.">        if (!(interactableEntity instanceof Mercenary) &amp;&amp; !(interactableEntity instanceof ZombieToastSpawner)) {</span>
<span class="fc" id="L590">            throw new IllegalArgumentException(&quot;not a mercenary or Zombie Spawner&quot;);</span>
        }
<span class="fc" id="L592">        Entity bow = null;</span>
<span class="fc" id="L593">        Entity sword = null;</span>
<span class="fc" id="L594">        Entity treasure = null;</span>
<span class="fc" id="L595">        Entity one_ring = null;</span>
<span class="fc" id="L596">        Entity sceptre = null;</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">        for (Entity item : loadedgame.getItems()) {</span>
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">            if (item instanceof Bow) {</span>
<span class="nc" id="L599">                bow = item;</span>
<span class="fc bfc" id="L600" title="All 4 branches covered.">            } else if (item instanceof TreasureEntity || item instanceof SunStone) {</span>
<span class="fc" id="L601">                treasure = item;</span>
<span class="fc bfc" id="L602" title="All 2 branches covered.">            } else if (item instanceof SwordEntity) {</span>
<span class="fc" id="L603">                sword = item;</span>
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">            } else if (item instanceof TheOneRingEntity) {</span>
<span class="nc" id="L605">                one_ring = item;</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">            } else if (item instanceof Sceptre) {</span>
<span class="fc" id="L607">                sceptre = item;</span>
            }
<span class="fc" id="L609">        }</span>

<span class="fc bfc" id="L611" title="All 4 branches covered.">        Boolean bribeMPossible = (treasure != null) || (sceptre != null);</span>
<span class="pc bpc" id="L612" title="1 of 4 branches missed.">        Boolean bribeAPossible = (one_ring != null) || (sceptre != null);</span>

<span class="fc bfc" id="L614" title="All 4 branches covered.">        if (!bribeMPossible &amp;&amp; interactableEntity instanceof Mercenary) {</span>
<span class="fc" id="L615">            throw new InvalidActionException(&quot;insufficient material to bribe&quot;);</span>
        }
<span class="fc bfc" id="L617" title="All 4 branches covered.">        if (!bribeAPossible &amp;&amp; interactableEntity instanceof Assassin) {</span>
<span class="fc" id="L618">            throw new InvalidActionException(&quot;insufficient material to bribe&quot;);</span>
        }
<span class="fc bfc" id="L620" title="All 2 branches covered.">        if (interactableEntity instanceof Mercenary) {</span>
<span class="pc bpc" id="L621" title="2 of 4 branches missed.">            if (!isMercenaryAdjacent(interactableEntity.getPos()) &amp;&amp; !RealisAdjacent(interactableEntity.getPos())) {</span>
<span class="nc" id="L622">                throw new InvalidActionException(&quot;not cardinally adjacent within 2 squares&quot;);</span>
            }
<span class="fc bfc" id="L624" title="All 2 branches covered.">            if (sceptre != null) {</span>
<span class="fc" id="L625">                ((Mercenary) interactableEntity).setTicksLeftOnBribe(10);</span>
<span class="fc" id="L626">                Character updateCharacter = loadedgame.getCharacter();</span>
<span class="fc" id="L627">                updateCharacter.addAlly((Mercenary) interactableEntity);</span>
<span class="fc" id="L628">                loadedgame.setCharacter(updateCharacter);</span>
<span class="fc" id="L629">                ((Mercenary) interactableEntity).setIsBribed(true);</span>
<span class="fc" id="L630">            } else {</span>
<span class="pc bpc" id="L631" title="1 of 2 branches missed.">                if (interactableEntity instanceof Assassin) {</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">                    if (one_ring != null) {</span>
<span class="nc" id="L633">                        loadedgame.removeItem(one_ring);</span>
<span class="nc" id="L634">                        Character updateCharacter = loadedgame.getCharacter();</span>
<span class="nc" id="L635">                        updateCharacter.addAlly((Assassin) interactableEntity);</span>
<span class="nc" id="L636">                        loadedgame.setCharacter(updateCharacter);</span>
<span class="nc" id="L637">                        ((Assassin) interactableEntity).setIsBribed(true);</span>
<span class="nc" id="L638">                    }</span>
                } else {
<span class="pc bpc" id="L640" title="1 of 4 branches missed.">                    if (treasure instanceof TreasureEntity || treasure instanceof SunStone) {</span>
<span class="fc bfc" id="L641" title="All 2 branches covered.">                        if (treasure instanceof TreasureEntity) {</span>
<span class="fc" id="L642">                            loadedgame.removeItem(treasure);</span>
                        }
<span class="fc" id="L644">                        Character updateCharacter = loadedgame.getCharacter();</span>
<span class="fc" id="L645">                        updateCharacter.addAlly((Mercenary) interactableEntity);</span>
<span class="fc" id="L646">                        loadedgame.setCharacter(updateCharacter);</span>
<span class="fc" id="L647">                        ((Mercenary) interactableEntity).setIsBribed(true);</span>
                    }
                }
            }
        }
<span class="fc bfc" id="L652" title="All 2 branches covered.">        if (interactableEntity instanceof ZombieToastSpawner) {</span>
<span class="fc bfc" id="L653" title="All 2 branches covered.">            if (!RealisAdjacent(interactableEntity.getPos())) {</span>
<span class="fc" id="L654">                throw new InvalidActionException(&quot;not cardianally adjacent&quot;);</span>
            }
<span class="pc bpc" id="L656" title="3 of 4 branches missed.">            if (sword == null &amp;&amp; bow == null) {</span>
<span class="nc" id="L657">                throw new InvalidActionException(&quot;no weapon&quot;);</span>
            }
<span class="pc bpc" id="L659" title="4 of 6 branches missed.">            if (RealisAdjacent(interactableEntity.getPos()) &amp;&amp; (sword != null || bow != null)) {</span>
<span class="fc" id="L660">                loadedgame.removeEntity(interactableEntity);</span>
            }
        }
<span class="fc" id="L663">        return new DungeonResponse(loadedgame.getId(), loadedgame.getName(), loadedgame.getEntityResponses(),</span>
<span class="fc" id="L664">                loadedgame.getItemResponses(), null, GoalFactory.goalString(loadedgame.getGoal()));</span>
    }

    /**
     * Checks if the character can craft a bow
     * 
     * @return boolean
     */
    public Boolean CheckBow() {
<span class="fc" id="L673">        int wood = 0;</span>
<span class="fc" id="L674">        int arrows = 0;</span>
<span class="fc" id="L675">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L676" title="All 2 branches covered.">        for (Entity item : dungeon.getItems()) {</span>
<span class="fc bfc" id="L677" title="All 2 branches covered.">            if (item.getType().equals(&quot;wood&quot;)) {</span>
<span class="fc" id="L678">                wood++;</span>
            }
<span class="fc bfc" id="L680" title="All 2 branches covered.">            if (item.getType().equals(&quot;arrow&quot;)) {</span>
<span class="fc" id="L681">                arrows++;</span>
            }
<span class="fc" id="L683">        }</span>
<span class="fc bfc" id="L684" title="All 4 branches covered.">        if (wood &gt;= 1 &amp;&amp; arrows &gt;= 3) {</span>
<span class="pc bpc" id="L685" title="1 of 2 branches missed.">            if (!dungeon.getBuildables().contains(&quot;bow&quot;)) {</span>
<span class="fc" id="L686">                dungeon.addToBuildableEntities(&quot;bow&quot;);</span>
            }
<span class="fc" id="L688">            return true;</span>
        }
<span class="fc" id="L690">        return false;</span>
    }

    /**
     * Checks if the character can craft a sceptre
     * 
     * @return boolean
     */
    public Boolean CheckSceptre() {
<span class="fc" id="L699">        int wood = 0;</span>
<span class="fc" id="L700">        int arrows = 0;</span>
<span class="fc" id="L701">        int keys = 0;</span>
<span class="fc" id="L702">        int treasure = 0;</span>
<span class="fc" id="L703">        int stone = 0;</span>
<span class="fc" id="L704">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L705" title="All 2 branches covered.">        for (Entity item : dungeon.getItems()) {</span>
<span class="fc bfc" id="L706" title="All 2 branches covered.">            if (item.getType().equals(&quot;wood&quot;)) {</span>
<span class="fc" id="L707">                wood++;</span>
            }
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">            if (item.getType().equals(&quot;arrow&quot;)) {</span>
<span class="nc" id="L710">                arrows++;</span>
            }
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">            if (item.getType().equals(&quot;keys&quot;)) {</span>
<span class="nc" id="L713">                keys++;</span>
            }
<span class="fc bfc" id="L715" title="All 2 branches covered.">            if (item.getType().equals(&quot;treasure&quot;)) {</span>
<span class="fc" id="L716">                treasure++;</span>
            }
<span class="fc bfc" id="L718" title="All 2 branches covered.">            if (item.getType().equals(&quot;sun_stone&quot;)) {</span>
<span class="fc" id="L719">                stone++;</span>
            }
<span class="fc" id="L721">        }</span>
<span class="pc bpc" id="L722" title="6 of 10 branches missed.">        if ((wood &gt;= 1 || arrows &gt;= 2) &amp;&amp; (keys &gt;= 1 || treasure &gt;= 1) &amp;&amp; stone &gt;= 1) {</span>
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">            if (!dungeon.getBuildables().contains(&quot;sceptre&quot;)) {</span>
<span class="fc" id="L724">                dungeon.addToBuildableEntities(&quot;sceptre&quot;);</span>
            }
<span class="fc" id="L726">            return true;</span>
        }
<span class="nc" id="L728">        return false;</span>
    }

    /**
     * Checks if the character can craft a sceptre
     * 
     * @return boolean
     */
    public Boolean CheckMidnightArmour() {
<span class="fc" id="L737">        boolean hasArmour = false;</span>
<span class="fc" id="L738">        boolean hasZombie = false;</span>
<span class="fc" id="L739">        int stone = 0;</span>
<span class="fc" id="L740">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L741" title="All 2 branches covered.">        for (Entity item : dungeon.getItems()) {</span>
<span class="fc bfc" id="L742" title="All 2 branches covered.">            if (item.getType().equals(&quot;armour&quot;)) {</span>
<span class="fc" id="L743">                hasArmour = true;</span>
            }
<span class="fc bfc" id="L745" title="All 2 branches covered.">            if (item.getType().equals(&quot;sun_stone&quot;)) {</span>
<span class="fc" id="L746">                stone++;</span>
            }
<span class="fc" id="L748">        }</span>
<span class="fc bfc" id="L749" title="All 2 branches covered.">        for (Entity entity : dungeon.getEntities()) {</span>
<span class="pc bpc" id="L750" title="1 of 2 branches missed.">            if (entity instanceof ZombieToast) {</span>
<span class="nc" id="L751">                hasZombie = true;</span>
            }
<span class="fc" id="L753">        }</span>
<span class="pc bpc" id="L754" title="3 of 6 branches missed.">        if (hasArmour &amp;&amp; stone &gt;= 1 &amp;&amp; !hasZombie) {</span>
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">            if (!dungeon.getBuildables().contains(&quot;midnight_armour&quot;)) {</span>
<span class="fc" id="L756">                dungeon.addToBuildableEntities(&quot;midnight_armour&quot;);</span>
            }
<span class="fc" id="L758">            return true;</span>
        }
<span class="nc" id="L760">        return false;</span>
    }

    /**
     * Checks if the character can craft a shield
     * 
     * @return boolean
     */
    public Boolean CheckShield() {
<span class="fc" id="L769">        int keys = 0;</span>
<span class="fc" id="L770">        int wood = 0;</span>
<span class="fc" id="L771">        int treasure = 0;</span>
<span class="fc" id="L772">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L773" title="All 2 branches covered.">        for (Entity item : dungeon.getItems()) {</span>
<span class="fc bfc" id="L774" title="All 2 branches covered.">            if (item.getType().equals(&quot;wood&quot;)) {</span>
<span class="fc" id="L775">                wood++;</span>
            }
<span class="pc bpc" id="L777" title="1 of 4 branches missed.">            if (item.getType().equals(&quot;key&quot;) &amp;&amp; ((KeyEntity) item).getIsUsed()) {</span>
<span class="fc" id="L778">                keys++;</span>
            }

<span class="fc bfc" id="L781" title="All 2 branches covered.">            if (item.getType().equals(&quot;treasure&quot;)) {</span>
<span class="fc" id="L782">                treasure++;</span>
            }
<span class="fc" id="L784">        }</span>
<span class="fc bfc" id="L785" title="All 6 branches covered.">        if ((treasure &gt;= 1 || keys &gt;= 1) &amp;&amp; wood &gt;= 1) {</span>
<span class="fc bfc" id="L786" title="All 2 branches covered.">            if (!dungeon.getBuildables().contains(&quot;shield&quot;)) {</span>
<span class="fc" id="L787">                dungeon.addToBuildableEntities(&quot;shield&quot;);</span>
            }
<span class="fc" id="L789">            return true;</span>
        }
<span class="fc" id="L791">        return false;</span>
    }

    /**
     * Builds a bow given the string of the type throws error if the desired craft
     * is not bow or shield
     * 
     * @param buildable
     * @return DungeonResponse
     * @throws IllegalArgumentException
     * @throws InvalidActionException
     */
    public DungeonResponse build(String buildable) throws IllegalArgumentException, InvalidActionException {
<span class="fc" id="L804">        List&lt;String&gt; builds = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L805">        builds.add(&quot;bow&quot;);</span>
<span class="fc" id="L806">        builds.add(&quot;shield&quot;);</span>
<span class="fc" id="L807">        builds.add(&quot;midnight_armour&quot;);</span>
<span class="fc" id="L808">        builds.add(&quot;sceptre&quot;);</span>
<span class="fc bfc" id="L809" title="All 2 branches covered.">        if (!builds.contains(buildable)) {</span>
<span class="fc" id="L810">            throw new IllegalArgumentException();</span>
        }
<span class="fc" id="L812">        DungeonMania dungeon = this.loadedgame;</span>
<span class="fc bfc" id="L813" title="All 2 branches covered.">        if (buildable.equals(&quot;bow&quot;)) {</span>
<span class="pc bpc" id="L814" title="1 of 2 branches missed.">            if (CheckBow()) {</span>
<span class="fc" id="L815">                dungeon.addBuildable(&quot;bow&quot;);</span>
            } else {
<span class="nc" id="L817">                throw new InvalidActionException(&quot;cannot build bow&quot;);</span>
            }
        }

<span class="fc bfc" id="L821" title="All 2 branches covered.">        if (buildable.equals(&quot;shield&quot;)) {</span>
<span class="pc bpc" id="L822" title="1 of 2 branches missed.">            if (CheckShield()) {</span>
<span class="fc" id="L823">                dungeon.addBuildable(&quot;shield&quot;);</span>
            } else {
<span class="nc" id="L825">                throw new InvalidActionException(&quot;cannot build shield&quot;);</span>
            }
        }

<span class="fc bfc" id="L829" title="All 2 branches covered.">        if (buildable.equals(&quot;midnight_armour&quot;)) {</span>
<span class="pc bpc" id="L830" title="1 of 2 branches missed.">            if (CheckMidnightArmour()) {</span>
<span class="fc" id="L831">                dungeon.addBuildable(&quot;midnight_armour&quot;);</span>
            } else {
<span class="nc" id="L833">                throw new InvalidActionException(&quot;cannot build midnight armour&quot;);</span>
            }
        }

<span class="fc bfc" id="L837" title="All 2 branches covered.">        if (buildable.equals(&quot;sceptre&quot;)) {</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">            if (CheckSceptre()) {</span>
<span class="fc" id="L839">                dungeon.addBuildable(&quot;sceptre&quot;);</span>
            } else {
<span class="nc" id="L841">                throw new InvalidActionException(&quot;cannot build sceptre&quot;);</span>
            }
        }

<span class="fc" id="L845">        return new DungeonResponse(loadedgame.getId(), loadedgame.getName(), loadedgame.getEntityResponses(),</span>
<span class="fc" id="L846">                loadedgame.getItemResponses(), loadedgame.getBuildables(),</span>
<span class="fc" id="L847">                GoalFactory.goalString(loadedgame.getGoal()));</span>
    }

    public DungeonResponse generateDungeon(int xStart, int yStart, int xEnd, int yEnd, String gameMode)
            throws IllegalArgumentException {
        // checking gameMode
<span class="fc" id="L853">        Boolean peaceful = gameMode.equalsIgnoreCase(&quot;peaceful&quot;);</span>
<span class="fc" id="L854">        Boolean standard = gameMode.equalsIgnoreCase(&quot;standard&quot;);</span>
<span class="fc" id="L855">        Boolean hard = gameMode.equalsIgnoreCase(&quot;hard&quot;);</span>
<span class="pc bpc" id="L856" title="5 of 6 branches missed.">        if (!peaceful &amp;&amp; !standard &amp;&amp; !hard) {</span>
<span class="nc" id="L857">            throw new IllegalArgumentException(&quot;invalid gamemode&quot;);</span>
        }

<span class="fc" id="L860">        Position start = new Position(xStart, yStart);</span>
<span class="fc" id="L861">        Position end = new Position(xEnd, yEnd);</span>
<span class="fc" id="L862">        List&lt;List&lt;Boolean&gt;&gt; grid = Prims.generate(50, 50, start, end);</span>
<span class="fc" id="L863">        DungeonMania dungeonMania = new DungeonMania(gameMode, &quot;RandomDungeon&quot;);</span>

<span class="fc" id="L865">        dungeonMania.createEntity(start, &quot;player&quot;);</span>
<span class="fc" id="L866">        dungeonMania.createEntity(end, &quot;exit&quot;);</span>

<span class="fc bfc" id="L868" title="All 2 branches covered.">        for (int i = 0; i &lt; 50; i++) {</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">            for (int j = 0; j &lt; 50; j++) {</span>
<span class="fc bfc" id="L870" title="All 2 branches covered.">                if (!grid.get(i).get(j)) {</span>
<span class="fc" id="L871">                    Position pos = new Position(i, j);</span>
<span class="fc" id="L872">                    dungeonMania.createEntity(pos, &quot;wall&quot;);</span>
                }
            }
        }

<span class="fc" id="L877">        JSONObject jsonGoalCondition = new JSONObject(&quot;{\&quot;goal\&quot;: \&quot;exit\&quot;}&quot;);</span>
<span class="fc" id="L878">        dungeonMania.setGoal(GoalFactory.generate(jsonGoalCondition.toString()));</span>
<span class="fc" id="L879">        List&lt;EntityResponse&gt; entityResponses = dungeonMania.getEntityResponses();</span>
<span class="fc" id="L880">        dungeonMania.setId(Integer.toString(this.games.size() + 1));</span>
<span class="fc" id="L881">        this.games.add(dungeonMania);</span>
<span class="fc" id="L882">        this.loadedgame = dungeonMania;</span>
<span class="fc" id="L883">        return new DungeonResponse(dungeonMania.getId(), &quot;RandomDungeon&quot;, entityResponses, new ArrayList&lt;&gt;(),</span>
<span class="fc" id="L884">                new ArrayList&lt;&gt;(), GoalFactory.goalString(dungeonMania.getGoal()));</span>
    }

    /**
     * Writes the given contents to a given filename
     * 
     * @param conts
     * @param filename
     */
    public void writeToFile(String conts, String filename) {
        try {
<span class="fc" id="L895">            FileWriter fw = new FileWriter(filename);</span>
<span class="fc" id="L896">            fw.write(conts);</span>
<span class="fc" id="L897">            fw.close();</span>
<span class="nc" id="L898">        } catch (IOException e) {</span>

<span class="fc" id="L900">        }</span>
<span class="fc" id="L901">    }</span>

    /**
     * Turns a given goal the a json file
     * 
     * @param goal
     * @return JSONObject
     */
    public JSONObject goalToJSON(Goal goal) {
<span class="fc" id="L910">        JSONObject jsonObject = new JSONObject();</span>

<span class="fc" id="L912">        jsonObject.put(&quot;goal&quot;, goal.getName());</span>

<span class="pc bpc" id="L914" title="1 of 2 branches missed.">        if (goal instanceof GoalComposite) {</span>
<span class="nc" id="L915">            List&lt;Goal&gt; subgoals = ((GoalComposite) goal).getSubgoals();</span>
<span class="nc" id="L916">            JSONArray array = new JSONArray();</span>
<span class="nc bnc" id="L917" title="All 2 branches missed.">            for (Goal subgoal : subgoals) {</span>
<span class="nc" id="L918">                array.put(goalToJSON(subgoal));</span>
<span class="nc" id="L919">            }</span>
<span class="nc" id="L920">            jsonObject.put(&quot;subgoals&quot;, array);</span>
        }

<span class="fc" id="L923">        return jsonObject;</span>
    }

    /**
     * Gets the loaded game
     * 
     * @return DungeonMania
     */
    public DungeonMania getLoadedGame() {
<span class="fc" id="L932">        return this.loadedgame;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>